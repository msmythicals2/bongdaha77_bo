// ==========================================
// BONGDAHA - main.js (FINAL INTEGRATED VERSION)
// ==========================================

// Load header and footer components
async function loadComponents() {
  try {
    const [headerRes, footerRes] = await Promise.all([
      fetch('/components/header.html'),
      fetch('/components/footer.html')
    ]);
    
    const headerHTML = await headerRes.text();
    const footerHTML = await footerRes.text();
    
    document.getElementById('header-placeholder').innerHTML = headerHTML;
    document.getElementById('footer-placeholder').innerHTML = footerHTML;
    
    // Start clock after header is loaded
    updateClock();
    setInterval(updateClock, 1000);
    
    // Load categories after components are loaded
    await loadNavCategories();
  } catch (err) {
    console.error('Failed to load components:', err);
  }
}

// Initialize components first
loadComponents();

const state = {
  tab: "all",
  date: new Date(),
  favorites: new Set(JSON.parse(localStorage.getItem("favMatches") || "[]")),
  collapsedLeagues: new Set(), // æ–°å¢ï¼šç”¨äºå­˜å‚¨è¢«æŠ˜å çš„è”èµ› ID
  carouselIndex: 0,
  lastFixtures: [],
  lastLive: [],
  selectedLeagueId: null,
};
let __REFRESHING__ = false;
const __CACHE__ = new Map(); // key -> { t, data }
const CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜ï¼Œæé«˜æ€§èƒ½

// å¢å¼ºçš„ç¼“å­˜ç³»ç»Ÿ
async function apiGetJSONCached(url, ttl = CACHE_TTL) {
  const now = Date.now();
  const hit = __CACHE__.get(url);
  
  if (hit && now - hit.t < ttl) {
    return hit.data;
  }

  try {
    const r = await fetch(url);
    if (!r.ok) {
      console.error("API failed:", url, r.status);
      return null;
    }
    
    const data = await r.json();
    __CACHE__.set(url, { t: now, data });
    return data;
  } catch (err) {
    console.error("Fetch error:", url, err);
    return null;
  }
}

async function apiGetJSON(url) {
  return apiGetJSONCached(url, CACHE_TTL);
}

// 1. å®šä¹‰ COMPETITIONS å›ºå®šè”èµ›æ•°æ®
const COMPETITION_DATA = [
  { id: 39, name: "Premier League", country: "England", logo: "https://media.api-sports.io/football/leagues/39.png" },
  { id: 140, name: "La Liga", country: "Spain", logo: "https://media.api-sports.io/football/leagues/140.png" },
  { id: 135, name: "Serie A", country: "Italy", logo: "https://media.api-sports.io/football/leagues/135.png" },
  { id: 78, name: "Bundesliga", country: "Germany", logo: "https://media.api-sports.io/football/leagues/78.png" },
  { id: 61, name: "Ligue 1", country: "France", logo: "https://media.api-sports.io/football/leagues/61.png" },
  { id: 340, name: "V.League 1", country: "Vietnam", logo: "https://media.api-sports.io/football/leagues/340.png" },
  { id: 88, name: "Eredivisie", country: "Netherlands", logo: "https://media.api-sports.io/football/leagues/88.png" },
  { id: 203, name: "SÃ¼per Lig", country: "Turkiye", logo: "https://media.api-sports.io/football/leagues/203.png" },
  { id: 40, name: "Championship", country: "England", logo: "https://media.api-sports.io/football/leagues/40.png" },
  { id: 2, name: "Champions League", country: "UEFA", logo: "https://media.api-sports.io/football/leagues/2.png" },
  { id: 3, name: "Europa League", country: "UEFA", logo: "https://media.api-sports.io/football/leagues/3.png" },
  { id: 848, name: "Conference League", country: "UEFA", logo: "https://media.api-sports.io/football/leagues/848.png" },
  { id: 94, name: "Primeira Liga", country: "Portugal", logo: "https://media.api-sports.io/football/leagues/94.png" },
  { id: 179, name: "Premiership", country: "Scotland", logo: "https://media.api-sports.io/football/leagues/179.png" },
  { id: 144, name: "Belgian Pro League", country: "Belgium", logo: "https://media.api-sports.io/football/leagues/144.png" },
  { id: 1, name: "World Cup 2026", country: "International", logo: "https://media.api-sports.io/football/leagues/1.png" }
];

// ---------- Helpers ----------

// === åŸºç¡€æ ¼å¼åŒ– ===
function pad2(n) {
  return String(n).padStart(2, "0");
}

function toYMD(d) {
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  return `${x.getFullYear()}-${pad2(x.getMonth() + 1)}-${pad2(x.getDate())}`;
}

function formatHHMM(dateStr) {
  const d = new Date(dateStr);
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

// === æ¯”èµ›çŠ¶æ€åˆ¤æ–­ ===
function isFinished(status) {
  // å¢åŠ  ABD(ä¸­æ–­), AWD(åˆ¤å†³), CANC(å–æ¶ˆ)
  return ["FT", "AET", "PEN", "ABD", "AWD", "CANC"].includes(status);
}

function isLiveStatus(status) {
  // ä¿æŒä¸å˜ï¼Œè¿™æ˜¯æ ‡å‡†çš„æ»šçƒçŠ¶æ€
  return ["1H", "2H", "HT", "ET", "BT", "P", "LIVE"].includes(status);
}

function isScheduled(status) {
  // å¢åŠ  PST(æ¨è¿Ÿ)ï¼Œç¡®ä¿æœªèµ›çš„éƒ½èƒ½æ˜¾ç¤º
  return ["NS", "TBD", "PST"].includes(status);
}

// === å®‰å…¨è¾“å‡º ===
function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function extractMatch(result) {
  return result?.response?.[0] || null;
}

// ================================
// League Page - Show / Hide Logic
// ================================

// è¿›å…¥è¯¦æƒ…é¡µ
function showLeaguePage() {
    const mainList = document.getElementById("fixtures-container");
    const leaguePage = document.getElementById("league-page");
    const dateRow = document.querySelector(".date-row");
    const tabsNav = document.querySelector(".tabs-nav");

    if (mainList) mainList.classList.add("hidden");
    if (dateRow) dateRow.classList.add("hidden");
    if (tabsNav) tabsNav.classList.add("hidden");
    
    if (leaguePage) {
        leaguePage.classList.remove("hidden");
        window.scrollTo(0, 0); // åˆ‡æ¢æ—¶å›åˆ°é¡¶éƒ¨
    }
}

function hideLeaguePage() {
    const mainList = document.getElementById("fixtures-container");
    const leaguePage = document.getElementById("league-page");
    const dateRow = document.querySelector(".date-row");
    const tabsNav = document.querySelector(".tabs-nav");

    if (leaguePage) leaguePage.classList.add("hidden");
    
    if (mainList) mainList.classList.remove("hidden");
    if (dateRow) dateRow.classList.remove("hidden");
    if (tabsNav) tabsNav.classList.remove("hidden");
    
    state.selectedLeagueId = null;
}

function loadLeaguePage(leagueId) {
  console.log("Loading League ID:", leagueId, typeof leagueId);
  if (!leagueId) return;

  const targetId = Number(leagueId);
  const league = COMPETITION_DATA.find(l => l.id === targetId);

  if (!league) {
    console.error("League not found in COMPETITION_DATA:", targetId);
    hideLeaguePage(); 
    return;
  }

  // --- ã€å…³é”®ä¿®æ”¹ã€‘æ˜¾ç¤º League Page å®¹å™¨ï¼Œéšè—ä¸»åˆ—è¡¨ ---
  const leaguePage = document.getElementById("league-page");

  // 2ï¸âƒ£ å¡«å…… Header (åŒ¹é…ä½ çš„ HTML ç»“æ„)
  const logoEl = document.querySelector("#league-page .league-logo-lg");
  const nameEl = document.querySelector("#league-page .league-name");
  const countryEl = document.querySelector("#league-page .league-country");
  const seasonEl = document.querySelector("#league-page .league-season");

  if (logoEl) logoEl.src = league.logo || "";
  if (nameEl) nameEl.textContent = league.name || "";
  if (countryEl) countryEl.textContent = league.country || "";
  if (seasonEl) seasonEl.textContent = league.season || "2025 / 2026";

  // 3ï¸âƒ£ é»˜è®¤åˆ‡æ¢ Tab çŠ¶æ€
  document.querySelectorAll(".league-tab").forEach(t =>
    t.classList.toggle("active", t.dataset.tab === "summary")
  );
  document.querySelectorAll(".league-panel").forEach(p =>
    p.classList.toggle("active", p.id === "league-summary")
  );

  // 4ï¸âƒ£ ç»‘å®šäº‹ä»¶ä¸æ¸²æŸ“å†…å®¹
  setupLeagueTabs();
  
  // Load the summary data immediately
  loadLeagueSummary(targetId);
}


// ---------- API ----------
async function apiGetJSON(url) {
  try {
    const r = await fetch(url);

    if (!r.ok) {
      console.error("API failed:", url, r.status);
      return null;
    }

    return await r.json();
  } catch (err) {
    console.error("Fetch error:", url, err);
    return null;
  }
}

async function loadFixturesByDateCached(d) {
  const key = `fx:${toYMD(d)}`;
  const now = Date.now();

  const hit = __CACHE__.get(key);
  if (hit && now - hit.t < CACHE_TTL) return hit.data;

  const data = await apiGetJSON(`/api/fixtures?date=${toYMD(d)}`);
  __CACHE__.set(key, { t: now, data: data || [] });
  return data || [];
}

const loadLive = () => apiGetJSON(`/api/live`);
// Load news from database API (latest 5 published articles)
const loadNews = async () => {
  try {
    await window.CONFIG_READY;
    const apiBase = window.APP_CONFIG?.adminApiUrl || 'http://localhost:8080';
    const res = await fetch(`${apiBase}/api/public/articles?page=1&page_size=5`);
    const data = await res.json();
    if (data.success) return data.data;
    return [];
  } catch (err) {
    console.error('Load news error:', err);
    return [];
  }
};

// ---------- Clock ----------
function updateClock() {
  const n = new Date();
  const el = document.getElementById("clock");
  if (!el) return;
  el.textContent = `${pad2(n.getDate())}/${pad2(n.getMonth()+1)}/${n.getFullYear()} ${pad2(n.getHours())}:${pad2(n.getMinutes())}:${pad2(n.getSeconds())}`;
}

// ---------- Date strip ----------
function renderDateStrip() {
  const strip = document.getElementById("date-strip");
  if (!strip) return;
  const days = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
  const todayYMD = toYMD(new Date());
  const base = new Date(state.date);
  const baseYMD = toYMD(base);
  let html = "";
  for (let i = -2; i <= 2; i++) {
    const d = new Date(base);
    d.setDate(base.getDate() + i);
    const ymd = toYMD(d);
    const label = ymd === todayYMD ? "TODAY" : days[d.getDay()];
    html += `<div class="date-chip ${ymd===baseYMD?"active":""}" data-ymd="${ymd}">
        <div class="d1">${pad2(d.getDate())}/${pad2(d.getMonth()+1)}</div>
        <div class="d2">${label}</div>
      </div>`;
  }
  strip.innerHTML = html;
  const dp = document.getElementById("datePicker");
  if (dp) dp.value = baseYMD;
}

function renderCompetitions() {
  const topContainer = document.getElementById('top-competitions');
  const allContainer = document.getElementById('all-competitions');
  if (!topContainer || !allContainer) return;
  const createItem = (c) => `
    <li class="flex items-center gap-3 p-2 hover:bg-[#252b31] rounded-md cursor-pointer group transition-colors ${state.selectedLeagueId === c.id ? 'bg-[#252b31]' : ''}" 
        data-action="filter-league" data-league-id="${c.id}">
        <img src="${c.logo}" class="league-logo-sm">
        <div class="flex flex-col min-w-0">
            <span class="text-[12px] font-bold text-gray-200 group-hover:text-[#00e676] truncate">${escapeHtml(c.name)}</span>
            <span class="text-[10px] text-gray-500">${escapeHtml(c.country)}</span>
        </div>
    </li>`;
  topContainer.innerHTML = COMPETITION_DATA.slice(0, 6).map(createItem).join('');
  allContainer.innerHTML = COMPETITION_DATA.slice(6).map(createItem).join('');
}

function renderLeftSidebar(fixtures) {
  const countryList = document.getElementById("countries-list");
  const pinnedList = document.getElementById("pinned-leagues");
  if (!fixtures) return;
  const leaguesMap = new Map();
  fixtures.forEach(f => {
    if (!leaguesMap.has(f.league.id)) leaguesMap.set(f.league.id, f.league);
  });
  if (countryList) {
    let cHtml = "";
    leaguesMap.forEach(l => {
      const activeCls = state.selectedLeagueId === l.id ? "bg-[#252b31] border-l-2 border-[#00e676]" : "";
      cHtml += `<div class="flex items-center gap-3 p-2 hover:bg-[#252b31] rounded-sm cursor-pointer group ${activeCls}" data-action="filter-league" data-league-id="${l.id}">
          <img src="${l.flag || l.logo}" class="w-4 h-3 object-cover rounded-[1px] opacity-80 group-hover:opacity-100">
          <span class="text-[11px] font-medium text-gray-400 group-hover:text-[#00e676] truncate">${escapeHtml(l.name)}</span>
        </div>`;
    });
    countryList.innerHTML = cHtml || '<div class="text-[10px] text-gray-600 p-2">No leagues</div>';
  }
  if (pinnedList) {
    const pinnedMap = new Map();
    fixtures.forEach(f => {
      if (state.favorites.has(f.fixture.id) && !pinnedMap.has(f.league.id)) pinnedMap.set(f.league.id, f.league);
    });
    let pHtml = "";
    pinnedMap.forEach(l => {
      pHtml += `<li class="flex items-center gap-3 p-2 hover:bg-[#252b31] rounded-sm cursor-pointer group" data-action="filter-league" data-league-id="${l.id}">
          <i class="fa-solid fa-thumbtack text-[10px] text-[#00e676]"></i>
          <span class="text-[11px] text-gray-300 group-hover:text-white truncate">${escapeHtml(l.name)}</span>
        </li>`;
    });
    pinnedList.innerHTML = pHtml || '<div class="text-[10px] text-gray-700 px-2 italic">No pinned items</div>';
  }
}

// ---------- Fixtures ----------
function applyTabFilter(all, live) {
    // 1. åˆå¹¶æ‰€æœ‰æ•°æ®å¹¶å»é‡ï¼ˆfixture.id å”¯ä¸€ï¼‰
    // è¿™æ ·ç¡®ä¿ ALL æ ‡ç­¾ä¸‹æ—¢æœ‰å·²ç»ç»“æŸçš„ï¼Œä¹Ÿæœ‰æ­£åœ¨æ»šçƒçš„
    const mergedMap = new Map();
    [...all, ...live].forEach(f => mergedMap.set(f.fixture.id, f));
    const dayMatches = Array.from(mergedMap.values());

    // 2. æ ¹æ® Tab é€»è¾‘è¿‡æ»¤
    switch (state.tab) {
        case "live":
            // ä»…æ˜¾ç¤ºæ­£åœ¨æ»šçƒçš„
            return live;

        case "finished":
            // ä»…æ˜¾ç¤ºå·²ç»“æŸçš„ (åˆ¤æ–­ FT, AET, PEN)
            return dayMatches.filter(f => isFinished(f.fixture.status.short));

        case "scheduled":
            // ä»…æ˜¾ç¤ºæœªå¼€èµ›çš„ (åˆ¤æ–­ NS, TBD)
            return dayMatches.filter(f => isScheduled(f.fixture.status.short));

        case "favorite":
            return dayMatches.filter(f => state.favorites.has(f.fixture.id))
                             .sort((a, b) => Number(isLiveStatus(b.fixture.status.short)) - Number(isLiveStatus(a.fixture.status.short)));

        case "all":
        default:
            // æ˜¾ç¤ºå½“å¤©æ‰€æœ‰ï¼šå·²ç»“æŸ + æ»šçƒ + æœªå¼€èµ›
            // æ’åºï¼šæ»šçƒä¸­çš„æ’æœ€ä¸Šé¢ï¼Œå…¶ä½™æŒ‰æ—¶é—´æ’
            return dayMatches.sort((a, b) => {
                const aLive = isLiveStatus(a.fixture.status.short);
                const bLive = isLiveStatus(b.fixture.status.short);
                if (aLive !== bLive) return Number(bLive) - Number(aLive);
                return new Date(a.fixture.date) - new Date(b.fixture.date);
            });
    }
}

function renderFixtures(fixtures, live) {
    const el = document.getElementById("fixtures-container");
    if (!el) return;

    let list = applyTabFilter(fixtures, live);
    if (state.selectedLeagueId) {
        list = list.filter(f => f.league.id === state.selectedLeagueId);
    }

    if (!list.length) {
        el.innerHTML = `<div class="loading-placeholder">No matches found</div>`;
        return;
    }

    // æŒ‰è”èµ›åˆ†ç»„
    const map = new Map();
    list.forEach(f => {
        if (!map.has(f.league.id)) map.set(f.league.id, { league: f.league, items: [] });
        map.get(f.league.id).items.push(f);
    });

let html = "";

// âœ… å…³é”®ï¼šMap â†’ Arrayï¼Œæ‰èƒ½æ‹¿åˆ° index
const leagueGroups = Array.from(map.entries());

leagueGroups.forEach(([leagueId, g], index) => {
    const l = g.league;

    // âœ… å‰ 10 ä¸ªè”èµ›é»˜è®¤å±•å¼€ï¼Œå…¶ä½™é»˜è®¤æŠ˜å 
    if (index >= 10 && !state.collapsedLeagues.has(leagueId)) {
        state.collapsedLeagues.add(leagueId);
    }

    const isCollapsed = state.collapsedLeagues.has(leagueId);
    const matchCount = g.items.length;

    html += `
        <div class="league-group" data-league-id="${leagueId}">
            <div class="league-header" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                <div class="league-info-left">
                    ${l.flag ? `<img class="league-flag" src="${l.flag}">` : ""}
                    ${l.logo ? `<img class="league-logo-md" src="${l.logo}">` : ""}
                    <span class="league-name-text">
                      ${escapeHtml(l.country)} - ${escapeHtml(l.name)}
                    </span>
                </div>

                <div class="league-header-right" style="display: flex; align-items: center; gap: 8px;">
                    <span class="match-count-badge"
                          style="display:${isCollapsed ? 'inline-block' : 'none'}; background:#374151; color:#00e676; font-size:11px; padding:2px 6px; border-radius:10px; font-weight:bold;">
                        ${matchCount}
                    </span>
                    <i class="fa-solid fa-chevron-${isCollapsed ? 'right' : 'down'}"></i>
                </div>
            </div>

            <div class="league-matches-container"
                 style="${isCollapsed ? 'display:none;' : 'display:block;'}">
                ${g.items.map(f => {
                    const s = f.fixture.status.short;
                    const isLive = isLiveStatus(s);
                    const isDone = isFinished(s);

                    // åªæ˜¾ç¤ºçœŸå®çš„Liveæ—¶é—´æ•°æ®
                    const getMatchTimeDisplay = (fixture) => {
                        const elapsed = fixture.status.elapsed;
                        const extra = fixture.status.extra;
                        
                        // åªæœ‰å½“APIæä¾›çœŸå®çš„elapsedæ—¶é—´æ—¶æ‰æ˜¾ç¤º
                        if (elapsed !== null && elapsed !== undefined) {
                            if (extra && extra > 0) {
                                return `${elapsed}+${extra}'`;
                            }
                            return `${elapsed}'`;
                        }
                        
                        // å¦‚æœæ²¡æœ‰çœŸå®çš„elapsedæ—¶é—´ï¼Œä¸æ˜¾ç¤ºæ—¶é—´
                        return '';
                    };

                    let timeHtml = isLive
                      ? `<span class="live-time"><span class="live-dot"></span>${getMatchTimeDisplay(f.fixture) || 'LIVE'}</span>`
                      : isDone
                        ? `<span class="status-finished">Finished</span>`
                        : formatHHMM(f.fixture.date);

                    return `
                        <div class="match-row" data-fixture-id="${f.fixture.id}" data-match-status="${f.fixture.status.short}">
                            <div class="match-left-group">
                                <div class="status-cell">${timeHtml}</div>
                                <div class="teams-container">
                                    <div class="team-line">
                                        <img class="team-logo" src="${f.teams.home.logo}">
                                        <span class="team-name">${escapeHtml(f.teams.home.name)}</span>
                                    </div>
                                    <div class="team-line">
                                        <img class="team-logo" src="${f.teams.away.logo}">
                                        <span class="team-name">${escapeHtml(f.teams.away.name)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="score-section">
                                <div class="scores-column">
                                    <div class="team-score ${isLive ? 'live' : ''}">${f.goals.home ?? "-"}</div>
                                    <div class="team-score ${isLive ? 'live' : ''}">${f.goals.away ?? "-"}</div>
                                </div>
                                <div class="vertical-divider"></div>
                            </div>

                            <div class="match-actions">
                                <a class="live-btn ${isLive ? 'active' : 'inactive'}"
                                   href="https://xoigac.tv/" target="_blank">LIVE</a>
                                <button class="odds-btn" data-action="open-odds">ODDS</button>
                                <div class="star-btn ${state.favorites.has(f.fixture.id) ? "on" : ""}"
                                     data-action="toggle-fav">
                                    <i class="fa-${state.favorites.has(f.fixture.id) ? "solid" : "regular"} fa-star"></i>
                                </div>
                            </div>
                        </div>`;
                }).join("")}
            </div>
        </div>`;
});

el.innerHTML = html;

}

// ---------- Right Sidebar ----------
function renderFeaturedLive(live = []) {
  const box = document.getElementById("live-carousel-content");
  if (!box) return;
  if (!live.length) {
    box.innerHTML = `<div class="loading-placeholder">No live matches</div>`;
    return;
  }
  const fx = live[state.carouselIndex % live.length];
  
  // åªæ˜¾ç¤ºçœŸå®çš„Liveæ—¶é—´æ•°æ®
  const getMatchTime = (fixture) => {
    const elapsed = fixture.status.elapsed;
    const extra = fixture.status.extra;
    
    // åªæœ‰å½“APIæä¾›çœŸå®çš„elapsedæ—¶é—´æ—¶æ‰æ˜¾ç¤º
    if (elapsed !== null && elapsed !== undefined) {
      if (extra && extra > 0) {
        return `${elapsed}+${extra}'`;
      }
      return `${elapsed}'`;
    }
    
    // å¦‚æœæ²¡æœ‰çœŸå®çš„elapsedæ—¶é—´ï¼Œä¸æ˜¾ç¤ºæ—¶é—´
    return '';
  };
  
  box.innerHTML = `
    <div class="text-center">
      <div class="text-[10px] text-gray-500 mb-2 uppercase tracking-widest">${escapeHtml(fx.league.name)}</div>
      <div class="flex items-center justify-around gap-2 mt-4">
        <div class="text-center">
          <img src="${fx.teams.home.logo}" class="w-10 h-10 mx-auto mb-2 object-contain">
          <div class="text-[11px] font-bold w-20 truncate">${escapeHtml(fx.teams.home.name)}</div>
        </div>
        <div class="text-xl font-black text-white">${fx.goals.home ?? 0} : ${fx.goals.away ?? 0}</div>
        <div class="text-center">
          <img src="${fx.teams.away.logo}" class="w-10 h-10 mx-auto mb-2 object-contain">
          <div class="text-[11px] font-bold w-20 truncate">${escapeHtml(fx.teams.away.name)}</div>
        </div>
      </div>
      <div class="mt-4 text-[10px] text-red-500 font-bold animate-pulse tracking-widest">
        ${getMatchTime(fx.fixture) ? `<span class="live-dot" style="display: inline-block; width: 6px; height: 6px; background-color: #ef4444; border-radius: 50%; margin-right: 4px; animation: pulse 2s infinite;"></span>${getMatchTime(fx.fixture)}` : 'LIVE'}
      </div>
    </div>
  `;
}

function renderNews(items) {
  const el = document.getElementById("news-container");
  if (!el) return;
  if (!items || !items.length) {
    el.innerHTML = `<div class="loading-placeholder">No news available</div>`;
    return;
  }
  el.innerHTML = items.slice(0,5).map(n => `
    <div class="news-item" onclick="window.location.href='/${n.slug}'">
      <div class="news-title">${escapeHtml(n.title)}</div>
      <div class="news-meta">
        <span class="tag">${n.category_name || 'Article'}</span>
        <span>${new Date(n.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>
      </div>
    </div>`).join("");
}

function updateLiveBadge(live) {
  const tab = document.querySelector(".tab-live");
  if (!tab) return;

  const hasLive = Array.isArray(live) && live.length > 0;
  tab.classList.toggle("has-live", hasLive);
}

// ---------- Match Detail Panel Logic ----------
async function openMatchDetails(matchId, rowElement) {
    // 1. å¦‚æœç‚¹å‡»çš„æ˜¯å·²ç»æ‰“å¼€çš„è¯¦æƒ…ï¼Œæ‰§è¡Œå…³é—­é€»è¾‘
    const existingDetail = document.querySelector(`.detail-expanded[data-for="${matchId}"]`);
    if (existingDetail) {
        existingDetail.remove();
        rowElement.classList.remove('is-active');
        return;
    }

    // 2. æ¸…é™¤æ‰€æœ‰å…¶ä»–è¡Œçš„è¯¦æƒ…å’Œæ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.detail-expanded').forEach(el => el.remove());
    document.querySelectorAll('.match-row, .result-item, .fixture-match-card').forEach(r => r.classList.remove('is-active'));

    // 3. ç»™å½“å‰ç‚¹å‡»çš„è¡ŒåŠ ä¸Šæ¿€æ´»çŠ¶æ€
    rowElement.classList.add('is-active');

    // 4. åˆ›å»ºè¯¦æƒ…å®¹å™¨
    const detailContainer = document.createElement('div');
    detailContainer.className = 'detail-expanded';
    detailContainer.dataset.for = matchId;
    detailContainer.innerHTML = `
        <div class="inline-loader">
            <div class="loading-spinner"></div>
            <p>Loading match details...</p>
        </div>
    `;
    
    // 5. å°†è¯¦æƒ…æ’å…¥åˆ°å½“å‰è¡Œä¹‹å
    rowElement.after(detailContainer);

    // 6. æ‰§è¡Œå¹³æ»‘æ»šåŠ¨
    setTimeout(() => {
        rowElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 50);

    // 7. è·å–æ¯”èµ›æ•°æ®
    try {
        const result = await Promise.race([
            apiGetJSON(`/api/fixture-detail?id=${matchId}`),
            new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), 3000)
            )
        ]);
        
        const match = extractMatch(result);

        if (!match) {
            detailContainer.innerHTML = `
                <div class="error-message">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <h3>No Data Available</h3>
                    <p>Unable to load match details</p>
                    <button class="retry-btn" onclick="openMatchDetails(${matchId}, this.closest('.detail-expanded').previousElementSibling)">
                        <i class="fa-solid fa-refresh"></i> Retry
                    </button>
                </div>
            `;
            return;
        }

        // 8. æ ¹æ®æ¯”èµ›çŠ¶æ€æ¸²æŸ“ä¸åŒå†…å®¹
        const matchStatus = match.fixture.status.short;
        const isScheduled = isScheduled(matchStatus);
        const isLive = isLiveStatus(matchStatus);
        const isFinished = isFinished(matchStatus);

        let tabsHtml = '';
        let contentHtml = '';

        if (isScheduled) {
            // æœªå¼€èµ›çš„æ¯”èµ›
            tabsHtml = `
                <div class="detail-tabs">
                    <button class="d-tab active" data-target="match">MATCH</button>
                    <button class="d-tab" data-target="odds">ODDS</button>
                    <button class="d-tab" data-target="h2h">H2H</button>
                    <button class="d-tab" data-target="standings">STANDINGS</button>
                </div>
            `;
            contentHtml = renderScheduledMatchTabs(match);
        } else if (isLive) {
            // è¿›è¡Œä¸­çš„æ¯”èµ›
            tabsHtml = `
                <div class="detail-tabs">
                    <button class="d-tab active" data-target="match">MATCH</button>
                    <button class="d-tab" data-target="odds">ODDS</button>
                    <button class="d-tab" data-target="h2h">H2H</button>
                    <button class="d-tab" data-target="standings">STANDINGS</button>
                </div>
            `;
            contentHtml = renderLiveMatchTabs(match);
        } else if (isFinished) {
            // å·²ç»“æŸçš„æ¯”èµ›
            tabsHtml = `
                <div class="detail-tabs">
                    <button class="d-tab active" data-target="match">MATCH</button>
                    <button class="d-tab" data-target="odds">ODDS</button>
                    <button class="d-tab" data-target="h2h">H2H</button>
                    <button class="d-tab" data-target="standings">STANDINGS</button>
                </div>
                <div class="detail-sub-tabs" style="display: block;">
                    <button class="d-sub-tab active" data-target="summary">SUMMARY</button>
                    <button class="d-sub-tab" data-target="stats">STATS</button>
                    <button class="d-sub-tab" data-target="lineups">LINEUPS</button>
                </div>
            `;
            contentHtml = renderFinishedMatchTabs(match);
        }

        // æ¸²æŸ“å®Œæ•´å†…å®¹
        detailContainer.innerHTML = `
          <div class="inline-detail-content">
            <div class="match-header-inline">
                <div class="teams-score">
                    <div class="team-info">
                        <img src="${match.teams.home.logo}" class="team-logo-md">
                        <span class="team-name">${escapeHtml(match.teams.home.name)}</span>
                    </div>
                    <div class="score-display">
                        ${match.goals.home !== null ? `${match.goals.home} - ${match.goals.away}` : 'VS'}
                        <div class="match-status">${match.fixture.status.long}</div>
                    </div>
                    <div class="team-info">
                        <img src="${match.teams.away.logo}" class="team-logo-md">
                        <span class="team-name">${escapeHtml(match.teams.away.name)}</span>
                    </div>
                </div>
            </div>
            ${tabsHtml}
            <div class="detail-body" id="inline-content-${matchId}">
               ${contentHtml}
            </div>
          </div>
        `;

        // ç»‘å®šä¸»æ ‡ç­¾é¡µäº‹ä»¶
        detailContainer.querySelectorAll('.d-tab').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const target = btn.dataset.target;
                const contentEl = document.getElementById(`inline-content-${matchId}`);
                
                // åˆ‡æ¢ä¸»æ ‡ç­¾
                detailContainer.querySelectorAll('.d-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // æ˜¾ç¤º/éšè—å­æ ‡ç­¾
                const subTabs = detailContainer.querySelector('.detail-sub-tabs');
                if (target === 'match' && isFinished) {
                    if (subTabs) subTabs.style.display = 'block';
                } else {
                    if (subTabs) subTabs.style.display = 'none';
                }
                
                // åŠ è½½å†…å®¹
                contentEl.innerHTML = '<div class="tab-loading"><div class="loading-spinner"></div></div>';
                
                setTimeout(() => {
                    if (target === "match") {
                        if (isScheduled) contentEl.innerHTML = renderScheduledMatchTabs(match);
                        else if (isLive) contentEl.innerHTML = renderLiveMatchTabs(match);
                        else if (isFinished) contentEl.innerHTML = renderFinishedMatchTabs(match);
                    } else if (target === "odds") {
                        contentEl.innerHTML = renderOddsTab();
                    } else if (target === "h2h") {
                        contentEl.innerHTML = renderH2HTab(match);
                    } else if (target === "standings") {
                        contentEl.innerHTML = renderStandingsTab(match);
                    }
                }, 100);
            });
        });

        // ç»‘å®šå­æ ‡ç­¾é¡µäº‹ä»¶ï¼ˆä»…å·²ç»“æŸæ¯”èµ›ï¼‰
        if (isFinished) {
            detailContainer.querySelectorAll('.d-sub-tab').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const target = btn.dataset.target;
                    const contentEl = document.getElementById(`inline-content-${matchId}`);
                    
                    detailContainer.querySelectorAll('.d-sub-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    contentEl.innerHTML = '<div class="tab-loading"><div class="loading-spinner"></div></div>';
                    
                    setTimeout(() => {
                        if (target === "summary") contentEl.innerHTML = renderSummary(match);
                        else if (target === "stats") contentEl.innerHTML = renderStats(match);
                        else if (target === "lineups") contentEl.innerHTML = renderLineups(match);
                    }, 100);
                });
            });
        }

    } catch (err) {
        console.error('Match detail error:', err);
        detailContainer.innerHTML = `
            <div class="error-message">
                <i class="fa-solid fa-wifi"></i>
                <h3>Connection Error</h3>
                <p>Please check your connection and try again</p>
                <button class="retry-btn" onclick="openMatchDetails(${matchId}, this.closest('.detail-expanded').previousElementSibling)">
                    <i class="fa-solid fa-refresh"></i> Retry
                </button>
            </div>
        `;
    }
}

// æ¸²æŸ“æœªå¼€èµ›æ¯”èµ›æ ‡ç­¾å†…å®¹
function renderScheduledMatchTabs(match) {
    return `
        <div class="match-info-section">
            <h3><i class="fa-solid fa-info-circle"></i> Match Information</h3>
            ${renderVenueInfo(match)}
            ${renderTeamForm(match)}
        </div>
    `;
}

// æ¸²æŸ“è¿›è¡Œä¸­æ¯”èµ›æ ‡ç­¾å†…å®¹
function renderLiveMatchTabs(match) {
    return `
        <div class="live-match-section">
            <div class="match-info-section">
                <h3><i class="fa-solid fa-info-circle"></i> Match Information</h3>
                ${renderVenueInfo(match)}
            </div>
            
            <div class="live-summary-section">
                <h3><i class="fa-solid fa-futbol"></i> Live Events</h3>
                <div class="live-events-tabs">
                    <button class="live-event-tab active" data-period="all">MATCH</button>
                    <button class="live-event-tab" data-period="1st">1ST HALF</button>
                    <button class="live-event-tab" data-period="2nd">2ND HALF</button>
                </div>
                <div class="live-events-content">
                    ${renderSummary(match)}
                </div>
            </div>
            
            <div class="watch-live-section">
                <a href="https://xoigac.tv/" target="_blank" class="watch-live-btn">
                    <i class="fa-solid fa-play"></i>
                    WATCH LIVE
                </a>
            </div>
            
            <div class="live-stats-section">
                <h3><i class="fa-solid fa-chart-bar"></i> Live Stats</h3>
                <div class="stats-period-tabs">
                    <button class="stats-period-tab active" data-period="match">MATCH</button>
                    <button class="stats-period-tab" data-period="1st">1ST HALF</button>
                    <button class="stats-period-tab" data-period="2nd">2ND HALF</button>
                </div>
                <div class="stats-content">
                    ${renderStats(match)}
                </div>
            </div>
        </div>
    `;
}

// æ¸²æŸ“å·²ç»“æŸæ¯”èµ›æ ‡ç­¾å†…å®¹
function renderFinishedMatchTabs(match) {
    return renderSummary(match); // é»˜è®¤æ˜¾ç¤ºSummary
}

// æ¸²æŸ“åœºé¦†ä¿¡æ¯
function renderVenueInfo(match) {
    const venue = match.fixture.venue;
    return `
        <div class="venue-info">
            ${venue?.name ? `
                <div class="info-item">
                    <span class="info-label">Stadium:</span>
                    <span class="info-value">${escapeHtml(venue.name)}</span>
                </div>
            ` : ''}
            ${venue?.capacity ? `
                <div class="info-item">
                    <span class="info-label">Capacity:</span>
                    <span class="info-value">${venue.capacity.toLocaleString()}</span>
                </div>
            ` : ''}
            ${venue?.city ? `
                <div class="info-item">
                    <span class="info-label">City:</span>
                    <span class="info-value">${escapeHtml(venue.city)}</span>
                </div>
            ` : ''}
            <div class="info-item">
                <span class="info-label">Date:</span>
                <span class="info-value">${new Date(match.fixture.date).toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Time:</span>
                <span class="info-value">${formatHHMM(match.fixture.date)}</span>
            </div>
        </div>
    `;
}

// æ¸²æŸ“çƒé˜ŸçŠ¶æ€
function renderTeamForm(match) {
    return `
        <div class="team-form-section">
            <h3><i class="fa-solid fa-chart-line"></i> Team Form</h3>
            <div class="form-comparison">
                <div class="team-form">
                    <div class="team-header">
                        <img src="${match.teams.home.logo}" class="team-logo-sm">
                        <span>${escapeHtml(match.teams.home.name)}</span>
                    </div>
                    <div class="form-dots">
                        <span class="form-dot form-w">W</span>
                        <span class="form-dot form-w">W</span>
                        <span class="form-dot form-d">D</span>
                        <span class="form-dot form-w">W</span>
                        <span class="form-dot form-l">L</span>
                    </div>
                </div>
                <div class="team-form">
                    <div class="team-header">
                        <img src="${match.teams.away.logo}" class="team-logo-sm">
                        <span>${escapeHtml(match.teams.away.name)}</span>
                    </div>
                    <div class="form-dots">
                        <span class="form-dot form-w">W</span>
                        <span class="form-dot form-d">D</span>
                        <span class="form-dot form-w">W</span>
                        <span class="form-dot form-w">W</span>
                        <span class="form-dot form-d">D</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// æ¸²æŸ“èµ”ç‡æ ‡ç­¾
function renderOddsTab() {
    return `
        <div class="coming-soon">
            <i class="fa-solid fa-clock"></i>
            <h3>Coming Soon</h3>
            <p>Odds data will be available soon</p>
        </div>
    `;
}

// æ¸²æŸ“H2Hæ ‡ç­¾
function renderH2HTab(match) {
    return `
        <div class="h2h-section">
            <h3><i class="fa-solid fa-history"></i> Head to Head</h3>
            <div class="coming-soon">
                <i class="fa-solid fa-clock"></i>
                <p>Head-to-head data coming soon</p>
            </div>
        </div>
    `;
}

// æ¸²æŸ“ç§¯åˆ†æ¦œæ ‡ç­¾
function renderStandingsTab(match) {
    return `
        <div class="standings-section">
            <h3><i class="fa-solid fa-trophy"></i> League Standings</h3>
            <div class="coming-soon">
                <i class="fa-solid fa-clock"></i>
                <p>Standings data coming soon</p>
            </div>
        </div>
    `;
}

function renderSummary(match) {
  if (!Array.isArray(match.events) || !match.events.length) {
    return `<div class="loading-placeholder">No events</div>`;
  }

  const rows = match.events
    .map(ev => {
      const isHome = ev.team?.id === match.teams.home.id;

     const name =
  ev.player?.name ||
  ev.assist?.name ||
  ev.player_in?.name ||
  ev.player_out?.name ||
  "";

      if (!name) return null; // å½»åº•è¿‡æ»¤â€œç©ºç™½è¡Œâ€

      let icon = "âš½";
      if (ev.type === "Card") icon = ev.detail === "Yellow Card" ? "ğŸŸ¨" : "ğŸŸ¥";
      if (ev.type === "subst") icon = "ğŸ”„";

      const t = ev.time?.elapsed != null ? `${ev.time.elapsed}'` : "";

      return `
        <div class="event-row">
          <div class="event-time">${t}</div>

          <div class="event-side home ${isHome ? "show" : ""}">
            ${isHome ? escapeHtml(name) : ""}
          </div>

          <div class="event-mid">
            <span class="event-icon">${icon}</span>
          </div>

          <div class="event-side away ${!isHome ? "show" : ""}">
            ${!isHome ? escapeHtml(name) : ""}
          </div>
        </div>
      `;
    })
    .filter(Boolean);

  if (!rows.length) {
    return `<div class="loading-placeholder">No visible events</div>`;
  }

  return `
    <div class="events-container events-2col">
      ${rows.join("")}
    </div>
  `;
}


// ---------- Stats ----------
function renderStats(match) {
  if (!Array.isArray(match.statistics) || match.statistics.length < 2) {
    return `<div class="loading-placeholder">No stats</div>`;
  }

  const homeStats = match.statistics[0]?.statistics || [];
  const awayStats = match.statistics[1]?.statistics || [];

  const types = [
    "Ball Possession",
    "Total Shots",
    "Shots on Goal",
    "Corner Kicks"
  ];

  const getValNum = (v) => {
    if (v == null) return 0;
    if (typeof v === "number") return v;
    if (typeof v === "string") return parseInt(v.replace("%",""), 10) || 0;
    return 0;
  };

  return `
    <div class="stats-container">
      ${types.map(type => {
        const hRaw = homeStats.find(s => s.type === type)?.value ?? 0;
        const aRaw = awayStats.find(s => s.type === type)?.value ?? 0;

        const h = getValNum(hRaw);
        const a = getValNum(aRaw);

        const total = (h + a) || 1;
        const hPct = Math.round((h / total) * 100);
        const aPct = 100 - hPct;

        const homeLead = h > a;
        const awayLead = a > h;

        return `
          <div class="stat-item">
            <div class="stat-info">
              <span class="stat-side ${homeLead ? "lead" : ""}">${escapeHtml(String(hRaw))}</span>
              <span class="stat-type">${escapeHtml(type)}</span>
              <span class="stat-side ${awayLead ? "lead" : ""}">${escapeHtml(String(aRaw))}</span>
            </div>

            <div class="stat-bar-bg">
              <div class="stat-bar-home ${homeLead ? "lead" : ""}" style="width:${hPct}%"></div>
              <div class="stat-bar-away ${awayLead ? "lead" : ""}" style="width:${aPct}%"></div>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

// ---------- Lineups (FINAL CLEAN VERSION) ----------
function renderLineups(match) {
  const ROW_GAP = 8.5;   // æ¯ä¸€æ’å‚ç›´é—´è·ï¼ˆ%ï¼‰
  const LEFT_MIN = 12;   // å·¦è¾¹ç•Œï¼ˆ%ï¼‰
  const LEFT_MAX = 88;   // å³è¾¹ç•Œï¼ˆ%ï¼‰

  const lineups = match.lineups;
  if (!Array.isArray(lineups) || lineups.length < 2) {
    return `<div class="loading-placeholder">No lineups</div>`;
  }

  const home =
    lineups.find(x => x.team?.id === match.teams.home.id) || lineups[0];
  const away =
    lineups.find(x => x.team?.id === match.teams.away.id) || lineups[1];

  const renderSide = (team, isAway) => {
    const players = team.startXI || [];
    if (!players.length) return "";

    // â‘  æŒ‰ row åˆ†ç»„
    const rows = {};
    players.forEach(p => {
      const grid = p.player?.grid;
      if (!grid) return;

      const [row, col] = grid.split(":").map(Number);
      if (!rows[row]) rows[row] = [];
      rows[row].push({ player: p.player, col });
    });

    // â‘¡ è¡Œå†…æŒ‰ col æ’åºï¼ˆå·¦ â†’ å³ï¼‰
    Object.values(rows).forEach(arr => {
      arr.sort((a, b) => a.col - b.col);
    });

    // â‘¢ æ¸²æŸ“
    return Object.entries(rows).map(([rowStr, rowPlayers]) => {
      const row = Number(rowStr);
      const count = rowPlayers.length;

      const span = LEFT_MAX - LEFT_MIN;
      const step = (count <= 1) ? 0 : span / (count - 1);

      return rowPlayers.map((item, i) => {
        const left = (count <= 1)
          ? 50
          : LEFT_MIN + step * i;

        const top = isAway
          ? row * ROW_GAP
          : 100 - row * ROW_GAP;

        const pl = item.player;

        return `
          <div class="player-dot ${isAway ? "away-p" : "home-p"}"
               style="left:${left}%; top:${top}%;">

            <div class="shirt">${pl.number ?? ""}</div>
            <div class="name">
              ${escapeHtml(pl.name.split(" ").slice(-1)[0])}
            </div>

          </div>
        `;
      }).join("");
    }).join("");
  };

  return `
    <div class="lineup-container">
      <div class="pitch">
        <div class="pitch-markings">
          <div class="half-line"></div>
          <div class="center-circle"></div>
          <div class="penalty-area top"></div>
          <div class="penalty-area bottom"></div>
          <div class="goal-area top"></div>
          <div class="goal-area bottom"></div>
        </div>

        <div class="team-label away-label">
          ${escapeHtml(away.team.name)} Â· ${away.formation || ""}
        </div>

        <div class="team-label home-label">
          ${escapeHtml(home.team.name)} Â· ${home.formation || ""}
        </div>

        ${renderSide(away, true)}
        ${renderSide(home, false)}
      </div>
    </div>
  `;
}

// ---------- Refresh & Events ----------
async function refreshAll() {
  if (__REFRESHING__) return;
  __REFRESHING__ = true;

  try {
    // â‘  ç«‹åˆ»æ¸²æŸ“ä¸ä¼šç­‰ API çš„ä¸œè¥¿ï¼ˆé¡µé¢å…ˆæ´»è¿‡æ¥ï¼‰
    renderDateStrip();
    renderCompetitions();

    // â‘¡ fixtures æœ€æ…¢ï¼Œå•ç‹¬ await
    const fx = await loadFixturesByDateCached(state.date);
    state.lastFixtures = fx || [];
    renderFixtures(state.lastFixtures, state.lastLive);
    renderLeftSidebar(state.lastFixtures);

    // â‘¢ live ä¸é˜»å¡ä¸»é¡µé¢
    loadLive().then(live => {
      state.lastLive = live || [];
      updateLiveBadge(state.lastLive);
      renderFeaturedLive(state.lastLive);
    });

    // â‘£ news ä¸é˜»å¡
    loadNews().then(news => {
      renderNews(news || []);
    });

  } catch (err) {
    console.error("refreshAll failed:", err);
  } finally {
    __REFRESHING__ = false;
  }
}

function refreshCenter() {
  renderFixtures(state.lastFixtures, state.lastLive);
  renderCompetitions();
  renderLeftSidebar(state.lastFixtures);
}

function bindEvents() {

  // é˜²æ­¢é‡å¤ç»‘å®šå…¨å±€ click
  if (window.__GLOBAL_CLICK_BOUND__) return;
  window.__GLOBAL_CLICK_BOUND__ = true;

  // Tabs
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      hideLeaguePage();
      state.tab = btn.dataset.tab;
      state.selectedLeagueId = null;
      document.querySelectorAll(".tab-btn").forEach(b =>
        b.classList.toggle("active", b === btn)
      );
      await refreshAll();
    });
  });

  // Sidebar Toggle
  const compBtn = document.getElementById('toggle-competitions');
  const allCompList = document.getElementById('all-competitions');
  const chevron = document.getElementById('comp-chevron');
  if (compBtn && allCompList) {
    compBtn.addEventListener('click', () => {
      const isHidden = allCompList.classList.contains('hidden');
      allCompList.classList.toggle('hidden');
      if (chevron) chevron.style.transform = isHidden ? 'rotate(90deg)' : 'rotate(0deg)';
    });
  }

  // Date Nav
  const prev = document.getElementById("btnPrevDay");
  const next = document.getElementById("btnNextDay");
  const dp = document.getElementById("datePicker");
  async function onDateChange(d) {
    state.date = d;
    state.selectedLeagueId = null;
    await refreshAll();
  }
  prev?.addEventListener("click", () => { const d = new Date(state.date); d.setDate(d.getDate() - 1); onDateChange(d); });
  next?.addEventListener("click", () => { const d = new Date(state.date); d.setDate(d.getDate() + 1); onDateChange(d); });
  dp?.addEventListener("change", () => { const [y, m, d] = dp.value.split("-").map(Number); onDateChange(new Date(y, m - 1, d)); });

  // Carousel
  document.getElementById("carousel-prev")?.addEventListener("click", () => { state.carouselIndex = state.carouselIndex > 0 ? state.carouselIndex - 1 : 0; renderFeaturedLive(state.lastLive); });
  document.getElementById("carousel-next")?.addEventListener("click", () => { state.carouselIndex++; renderFeaturedLive(state.lastLive); });

  // ===== Global Clicks (Fav, Filter, Inline Details) =====
  document.addEventListener("click", e => {

    // 0. è¿”å›é¦–é¡µæŒ‰é’® (æ–°å¢)
    if (e.target.closest("#back-to-home")) {
      hideLeaguePage();
      return;
    }

    // 1. æ—¥æœŸ chip ç‚¹å‡»
    const chip = e.target.closest(".date-chip");
    if (chip) {
      const [y, m, d] = chip.dataset.ymd.split("-").map(Number);
      state.date = new Date(y, m - 1, d);
      state.selectedLeagueId = null;
      refreshAll();
      return;
    }

    // 2. æ”¶è—æ˜Ÿå·
    const fav = e.target.closest("[data-action='toggle-fav']");
    if (fav) {
      e.stopPropagation();
const row = fav.closest(".match-row");
if (!row) return;

const id = Number(row.dataset.fixtureId || row.getAttribute("data-fixture-id"));
if (!id) return;
      const isAdding = !state.favorites.has(id);
      if (isAdding) state.favorites.add(id); else state.favorites.delete(id);
      localStorage.setItem("favMatches", JSON.stringify([...state.favorites]));
      document.querySelectorAll(`.match-row[data-fixture-id="${id}"] [data-action="toggle-fav"]`)
        .forEach(starElement => {
          if (isAdding) {
            starElement.classList.add("on");
            starElement.innerHTML = '<i class="fa-solid fa-star"></i>';
          } else {
            starElement.classList.remove("on");
            starElement.innerHTML = '<i class="fa-regular fa-star"></i>';
          }
        });
      return;
    }

    // 3. ODDS æŒ‰é’®
    const oddsBtn = e.target.closest("[data-action='open-odds']");
    if (oddsBtn) {
      e.stopPropagation();
      window.open("https://www.ab77-vip.com", "_blank");
      return;
    }

    // 4. LIVE æŒ‰é’®
    const liveLink = e.target.closest(".live-btn");
    if (liveLink) {
      e.stopPropagation();
      return;
    }

// 5. ä¾§è¾¹æ /åˆ—è¡¨è”èµ›ç‚¹å‡»ï¼ˆè¿›å…¥ League Pageï¼‰
const lg = e.target.closest("[data-action='filter-league']");
if (lg) {
    const lid = Number(lg.dataset.leagueId);
    state.selectedLeagueId = lid;
    
    // æå‡ä½“éªŒï¼šå…ˆæ˜¾ç¤ºè¯¦æƒ…é¡µå¹¶æ”¾ä¸€ä¸ªè½¬åœˆåœˆ
    showLeaguePage();
    const summaryContainer = document.getElementById("summary-content");
    if (summaryContainer) {
        summaryContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center p-20">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-[#00e676]"></div>
                <p class="text-gray-500 mt-4 text-sm">Fetching league data...</p>
            </div>`;
    }

    loadLeaguePage(lid); 
    return;
}

    // 5.5 è”èµ›è¡ŒæŠ˜å åˆ‡æ¢
    const leagueHeader = e.target.closest(".league-header");
    // å…³é”®ä¿®æ­£ï¼šåªæœ‰åœ¨éè¯¦æƒ…é¡µï¼ˆå³ä¸»é¡µåˆ—è¡¨ï¼‰æ—¶æ‰è§¦å‘æŠ˜å é€»è¾‘
    if (leagueHeader && !e.target.closest("#league-page")) {
      const group = leagueHeader.closest(".league-group");
      if (!group) return; // é˜²æ­¢åœ¨éåˆ†ç»„å†…ç‚¹å‡»æŠ¥é”™
      
      const leagueId = Number(group.dataset.leagueId);
      const container = group.querySelector(".league-matches-container");
      const icon = leagueHeader.querySelector("i");
      const countBadge = leagueHeader.querySelector(".match-count-badge");

      if (state.collapsedLeagues.has(leagueId)) {
        state.collapsedLeagues.delete(leagueId);
        if (container) container.style.display = "block";
        icon?.classList.replace("fa-chevron-right", "fa-chevron-down");
        if (countBadge) countBadge.style.display = "none";
      } else {
        state.collapsedLeagues.add(leagueId);
        if (container) container.style.display = "none";
        icon?.classList.replace("fa-chevron-down", "fa-chevron-right");
        if (countBadge) countBadge.style.display = "inline-block";
      }
      return;
    }

    // 6. ç‚¹å‡» match-row æ•´è¡Œï¼Œåœ¨è¡Œä¸‹å±•å¼€è¯¦æƒ…
    const row = e.target.closest(".match-row");
    if (row) {
      // é˜²æ­¢åœ¨æ“ä½œæŒ‰é’®åŒºåŸŸç‚¹å‡»æ—¶è§¦å‘
      if (e.target.closest(".match-actions")) return;
      
      const matchId = Number(row.dataset.fixtureId);
      if (!matchId) return;
      
      // ä½¿ç”¨ä¼˜åŒ–çš„è¯¦æƒ…å±•å¼€å‡½æ•°
      openMatchDetails(matchId, row);
      return;
    }

  });
  
  // åˆå§‹åŒ–ç»‘å®šè¯¦æƒ…é¡µ Tab åˆ‡æ¢
  setupLeagueTabs();
  
} // bindEvents ç»“æŸ

function setupLeagueTabs() {
  const container = document.getElementById("league-tabs"); 
  if (!container || container.dataset.init === "true") return;
  
  container.dataset.init = "true"; // é˜²æ­¢é‡å¤åˆå§‹åŒ–

  container.addEventListener("click", e => {
    const tab = e.target.closest(".league-tab");
    if (!tab) return;

    const key = tab.dataset.tab;
    
    // 1. åˆ‡æ¢ Tab æŒ‰é’®é«˜äº®
    container.querySelectorAll(".league-tab").forEach(t => t.classList.remove("active"));
    tab.classList.add("active");

    // 2. åˆ‡æ¢å¯¹åº”çš„é¢æ¿
    document.querySelectorAll(".league-panel").forEach(panel => {
      panel.classList.toggle("active", panel.id === `league-${key}`);
    });

    // 3. æ ¹æ®é€‰æ‹©çš„æ ‡ç­¾åŠ è½½å¯¹åº”æ•°æ®
    const leagueId = state.selectedLeagueId;
    if (!leagueId) return;

    switch(key) {
      case 'summary':
        loadLeagueSummary(leagueId);
        break;
      case 'fixtures':
        loadLeagueFixtures(leagueId);
        break;
      case 'results':
        loadLeagueResults(leagueId);
        break;
      case 'standings':
        loadLeagueStandings(leagueId);
        break;
      case 'h2h':
        loadLeagueH2H(leagueId);
        break;
    }
  });
}

// å¢å¼ºç¼“å­˜ç³»ç»Ÿ
const LEAGUE_CACHE = new Map(); // è”èµ›ä¸“ç”¨ç¼“å­˜
const LEAGUE_CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜

// ç¼“å­˜è”èµ›æ•°æ®
function cacheLeagueData(key, data) {
  LEAGUE_CACHE.set(key, {
    data: data,
    timestamp: Date.now()
  });
}

// è·å–ç¼“å­˜çš„è”èµ›æ•°æ®
function getCachedLeagueData(key) {
  const cached = LEAGUE_CACHE.get(key);
  if (!cached) return null;
  
  if (Date.now() - cached.timestamp > LEAGUE_CACHE_TTL) {
    LEAGUE_CACHE.delete(key);
    return null;
  }
  
  return cached.data;
}

// åŠ è½½è”èµ›ç»¼åˆæ¦‚è§ˆ (Summary) - Enhanced Flashscore Style
async function loadLeagueSummary(leagueId) {
  const container = document.getElementById("league-summary");
  if (!container) return;
  
  container.innerHTML = '<div class="loading-placeholder">Loading summary...</div>';
  
  try {
    // æ£€æŸ¥ç¼“å­˜
    const cacheKey = `summary-${leagueId}`;
    const cachedData = getCachedLeagueData(cacheKey);
    
    if (cachedData) {
      renderSummaryData(container, cachedData);
      return;
    }
    
    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
    const [upcomingFixtures, recentResults, standings] = await Promise.all([
      getUpcomingFixtures(leagueId, 6), // å‡å°‘åˆ°6åœºæ¯”èµ›
      getRecentResults(leagueId, 6),    // å‡å°‘åˆ°6åœºç»“æœ
      apiGetJSON(`/api/standings?league=${leagueId}&season=2025`)
    ]);
    
    const summaryData = { upcomingFixtures, recentResults, standings };
    cacheLeagueData(cacheKey, summaryData);
    renderSummaryData(container, summaryData);
    
  } catch (error) {
    console.error('Error loading league summary:', error);
    container.innerHTML = '<div class="loading-placeholder">Error loading summary</div>';
  }
}

// æ¸²æŸ“Summaryæ•°æ®çš„ç‹¬ç«‹å‡½æ•°
function renderSummaryData(container, { upcomingFixtures, recentResults, standings }) {
  let html = '<div class="summary-container">';
  
  // === FIXTURES SECTION ===
  if (upcomingFixtures.length > 0) {
    html += `
      <div class="summary-section fixtures-section">
        <div class="summary-section-header">
          <h3><i class="fa-solid fa-calendar-days"></i> Upcoming Fixtures</h3>
          <a href="#" class="view-all-link" onclick="document.querySelector('[data-tab=fixtures]').click()">View All</a>
        </div>
        <div class="summary-fixtures-list">
          ${upcomingFixtures.map(match => `
            <div class="summary-fixture-item">
              <div class="fixture-time-info">
                <div class="fixture-date">${new Date(match.fixture.date).toLocaleDateString('en-US', {
                  month: 'short', day: 'numeric'
                })}</div>
                <div class="fixture-time">${formatHHMM(match.fixture.date)}</div>
              </div>
              <div class="fixture-teams">
                <div class="fixture-team-row home">
                  <img src="${match.teams.home.logo}" class="team-logo-sm">
                  <span class="team-name">${escapeHtml(match.teams.home.name)}</span>
                </div>
                <div class="fixture-team-row away">
                  <img src="${match.teams.away.logo}" class="team-logo-sm">
                  <span class="team-name">${escapeHtml(match.teams.away.name)}</span>
                </div>
              </div>
              <div class="fixture-actions">
                <button class="live-btn inactive">LIVE</button>
                <button class="odds-btn">ODDS</button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // === RESULTS SECTION ===
  if (recentResults.length > 0) {
    html += `
      <div class="summary-section results-section">
        <div class="summary-section-header">
          <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Results</h3>
          <a href="#" class="view-all-link" onclick="document.querySelector('[data-tab=results]').click()">View All</a>
        </div>
        <div class="summary-results-grid">
          ${recentResults.map(match => `
            <div class="summary-result-card">
              <div class="result-datetime">
                <div class="result-date">
                  ${new Date(match.fixture.date).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric'
                  })}
                </div>
                <div class="result-round">${match.league.round || 'Regular Season'}</div>
              </div>
              <div class="result-matchup">
                <div class="result-team home">
                  <img src="${match.teams.home.logo}" class="team-logo-xs">
                  <span class="team-name">${escapeHtml(match.teams.home.name)}</span>
                </div>
                <div class="result-score">
                  <span class="score-home ${(match.goals.home > match.goals.away) ? 'winner' : ''}">${match.goals.home}</span>
                  <span class="score-sep">-</span>
                  <span class="score-away ${(match.goals.away > match.goals.home) ? 'winner' : ''}">${match.goals.away}</span>
                </div>
                <div class="result-team away">
                  <img src="${match.teams.away.logo}" class="team-logo-xs">
                  <span class="team-name">${escapeHtml(match.teams.away.name)}</span>
                </div>
              </div>
              <div class="result-status">${match.fixture.status.short}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // === STANDINGS SECTION ===
  if (standings && standings.length > 0 && standings[0].league.standings) {
    const topTeams = standings[0].league.standings[0].slice(0, 8); // Top 8 teams
    html += `
      <div class="summary-section standings-section">
        <div class="summary-section-header">
          <h3><i class="fa-solid fa-trophy"></i> League Table (Top 8)</h3>
          <a href="#" class="view-all-link" onclick="document.querySelector('[data-tab=standings]').click()">View Full Table</a>
        </div>
        <div class="summary-standings-table">
          <div class="standings-header">
            <div class="pos">#</div>
            <div class="team">Team</div>
            <div class="played">P</div>
            <div class="points">Pts</div>
            <div class="form">Form</div>
          </div>
          ${topTeams.map(team => `
            <div class="standings-row ${getPositionClass(team.rank)}">
              <div class="pos">${team.rank}</div>
              <div class="team">
                <img src="${team.team.logo}" class="team-logo-xs">
                <span class="team-name">${escapeHtml(team.team.name)}</span>
              </div>
              <div class="played">${team.all.played}</div>
              <div class="points">${team.points}</div>
              <div class="form">
                ${(team.form || 'WWWWW').split('').slice(0, 5).map(result => 
                  `<span class="form-dot form-${result.toLowerCase()}">${result}</span>`
                ).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // If no data available
  if (upcomingFixtures.length === 0 && recentResults.length === 0 && (!standings || !standings.length)) {
    html += '<div class="loading-placeholder">No data available for this league</div>';
  }
  
  html += '</div>';
  container.innerHTML = html;
}

// åŠ è½½è”èµ›èµ›ç¨‹ (Fixtures) - ç¾åŒ–ç‰ˆæœ¬
async function loadLeagueFixtures(leagueId) {
  const container = document.getElementById("league-fixtures");
  if (!container) return;
  
  container.innerHTML = '<div class="loading-placeholder">Loading fixtures...</div>';
  
  try {
    const fixtures = await getUpcomingFixtures(leagueId, 30); // è·å–30åœºå³å°†è¿›è¡Œçš„æ¯”èµ›
    
    if (fixtures.length === 0) {
      container.innerHTML = '<div class="loading-placeholder">No upcoming fixtures found</div>';
      return;
    }
    
    // æŒ‰è½®æ¬¡åˆ†ç»„
    const fixturesByRound = groupFixturesByRound(fixtures);
    
    let html = `
      <div class="fixtures-container">
        <div class="fixtures-header">
          <div class="fixtures-title">
            <i class="fa-solid fa-calendar-days"></i>
            <h3>Upcoming Fixtures</h3>
          </div>
          <span class="fixtures-count">${fixtures.length} matches</span>
        </div>
        <div class="fixtures-list">
    `;
    
    Object.entries(fixturesByRound).forEach(([round, matches]) => {
      html += `
        <div class="fixtures-round">
          <div class="round-header">
            <h4 class="round-title">${escapeHtml(round)}</h4>
            <span class="round-count">${matches.length} matches</span>
          </div>
          <div class="round-fixtures">
            ${matches.map(match => `
              <div class="fixture-match-card" data-fixture-id="${match.fixture.id}" data-match-status="${match.fixture.status.short}">
                <div class="match-datetime">
                  <div class="match-date">
                    ${new Date(match.fixture.date).toLocaleDateString('en-US', {
                      day: '2-digit', month: '2-digit'
                    })}
                  </div>
                  <div class="match-time">${formatHHMM(match.fixture.date)}</div>
                </div>
                
                <div class="match-teams">
                  <div class="team-row home-team">
                    <img src="${match.teams.home.logo}" class="team-logo">
                    <span class="team-name">${escapeHtml(match.teams.home.name)}</span>
                  </div>
                  <div class="vs-separator">
                    <span class="vs-text">VS</span>
                  </div>
                  <div class="team-row away-team">
                    <img src="${match.teams.away.logo}" class="team-logo">
                    <span class="team-name">${escapeHtml(match.teams.away.name)}</span>
                  </div>
                </div>
                
                <div class="match-actions">
                  <button class="action-btn live-btn inactive">
                    <i class="fa-solid fa-play"></i>
                    LIVE
                  </button>
                  <button class="action-btn odds-btn" onclick="window.open('https://www.ab77-vip.com', '_blank')">
                    <i class="fa-solid fa-chart-line"></i>
                    ODDS
                  </button>
                  <button class="action-btn star-btn" data-fixture-id="${match.fixture.id}">
                    <i class="fa-regular fa-star"></i>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    
    // ç»‘å®šæ”¶è—æŒ‰é’®äº‹ä»¶å’Œæ¯”èµ›å¡ç‰‡ç‚¹å‡»äº‹ä»¶
    container.querySelectorAll('.star-btn').forEach(btn => {
      const fixtureId = parseInt(btn.dataset.fixtureId);
      const isFavorite = state.favorites.has(fixtureId);
      
      if (isFavorite) {
        btn.classList.add('active');
        btn.innerHTML = '<i class="fa-solid fa-star"></i>';
      }
      
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isAdding = !state.favorites.has(fixtureId);
        
        if (isAdding) {
          state.favorites.add(fixtureId);
          btn.classList.add('active');
          btn.innerHTML = '<i class="fa-solid fa-star"></i>';
        } else {
          state.favorites.delete(fixtureId);
          btn.classList.remove('active');
          btn.innerHTML = '<i class="fa-regular fa-star"></i>';
        }
        
        localStorage.setItem("favMatches", JSON.stringify([...state.favorites]));
      });
    });
    
    // ç»‘å®šæ¯”èµ›å¡ç‰‡ç‚¹å‡»äº‹ä»¶
    container.querySelectorAll('.fixture-match-card').forEach(card => {
      card.addEventListener('click', (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯æ“ä½œæŒ‰é’®ï¼Œä¸è§¦å‘å¡ç‰‡ç‚¹å‡»
        if (e.target.closest('.match-actions')) return;
        
        const fixtureId = parseInt(card.dataset.fixtureId);
        if (!fixtureId) return;
        
        // ä½¿ç”¨ç»Ÿä¸€çš„è¯¦æƒ…å±•å¼€å‡½æ•°
        openMatchDetails(fixtureId, card);
      });
    });
    
  } catch (error) {
    console.error('Error loading fixtures:', error);
    container.innerHTML = '<div class="loading-placeholder">Error loading fixtures. Please try again.</div>';
  }
}

// è·å–å³å°†è¿›è¡Œçš„æ¯”èµ› - ä¼˜åŒ–ç‰ˆæœ¬
async function getUpcomingFixtures(leagueId, limit = 10) {
  try {
    const currentDate = new Date();
    const fixtures = [];
    
    // åªæŸ¥æ‰¾æœªæ¥7å¤©çš„æ¯”èµ›ï¼Œå‡å°‘APIè°ƒç”¨
    for (let i = 0; i < 7; i++) {
      const date = new Date(currentDate);
      date.setDate(currentDate.getDate() + i);
      
      const dayFixtures = await loadFixturesByDateCached(date);
      const leagueFixtures = dayFixtures.filter(f => 
        f.league.id === leagueId && isScheduled(f.fixture.status.short)
      );
      
      fixtures.push(...leagueFixtures);
      
      if (fixtures.length >= limit) break;
    }
    
    return fixtures.slice(0, limit).sort((a, b) => 
      new Date(a.fixture.date) - new Date(b.fixture.date)
    );
  } catch (error) {
    console.error('Error getting upcoming fixtures:', error);
    return [];
  }
}

// ========================================
// LEAGUE RESULTS AND STANDINGS FUNCTIONS
// ========================================
        content.classList.toggle('active', content.dataset.content === tabName);
      });
    });
  });
  
  // å­æ ‡ç­¾é¡µåˆ‡æ¢ï¼ˆä»…ç”¨äºå·²ç»“æŸçš„æ¯”èµ›ï¼‰
  container.querySelectorAll('.inline-sub-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const subTabName = tab.dataset.subtab;
      
      // åˆ‡æ¢å­æ ‡ç­¾é¡µæ¿€æ´»çŠ¶æ€
      container.querySelectorAll('.inline-sub-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // åˆ‡æ¢å­å†…å®¹æ˜¾ç¤º
      container.querySelectorAll('.sub-tab-content').forEach(content => {
        content.classList.toggle('active', content.dataset.subcontent === subTabName);
      });
    });
  });
}

// æ ¹æ®æ¯”èµ›çŠ¶æ€æ¸²æŸ“å†…å®¹
function renderMatchDetailContent(container, match, matchStatus) {
  const isScheduledMatch = isScheduled(matchStatus);
  const isLiveMatch = isLiveStatus(matchStatus);
  const isFinishedMatch = isFinished(matchStatus);
  
  // åŸºç¡€å¤´éƒ¨ä¿¡æ¯
  const headerHtml = `
    <div class="modal-header">
      <div class="match-header-info">
        <div class="team-info">
          <img src="${match.teams.home.logo}" class="team-logo-lg">
          <span class="team-name">${escapeHtml(match.teams.home.name)}</span>
        </div>
        <div class="match-score">
          ${isFinishedMatch || isLiveMatch ? `${match.goals.home} - ${match.goals.away}` : 'VS'}
          <div class="match-status">${match.fixture.status.long}</div>
        </div>
        <div class="team-info">
          <img src="${match.teams.away.logo}" class="team-logo-lg">
          <span class="team-name">${escapeHtml(match.teams.away.name)}</span>
        </div>
      </div>
      <button class="close-btn" onclick="closeMatchDetailModal()">&times;</button>
    </div>
  `;
  
  // æ ¹æ®çŠ¶æ€é€‰æ‹©æ ‡ç­¾é¡µ
  let tabsHtml = '';
  let contentHtml = '';
  
  if (isScheduledMatch) {
    // æœªå¼€èµ›çš„æ¯”èµ›
    tabsHtml = `
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="match">MATCH</button>
        <button class="modal-tab" data-tab="odds">ODDS</button>
        <button class="modal-tab" data-tab="h2h">H2H</button>
        <button class="modal-tab" data-tab="standings">STANDINGS</button>
      </div>
    `;
    contentHtml = renderScheduledMatchContent(match);
  } else if (isLiveMatch) {
    // è¿›è¡Œä¸­çš„æ¯”èµ›
    tabsHtml = `
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="match">MATCH</button>
        <button class="modal-tab" data-tab="odds">ODDS</button>
        <button class="modal-tab" data-tab="h2h">H2H</button>
        <button class="modal-tab" data-tab="standings">STANDINGS</button>
      </div>
    `;
    contentHtml = renderLiveMatchContent(match);
  } else if (isFinishedMatch) {
    // å·²ç»“æŸçš„æ¯”èµ›
    tabsHtml = `
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="match">MATCH</button>
        <button class="modal-tab" data-tab="odds">ODDS</button>
        <button class="modal-tab" data-tab="h2h">H2H</button>
        <button class="modal-tab" data-tab="standings">STANDINGS</button>
      </div>
      <div class="modal-sub-tabs">
        <button class="modal-sub-tab active" data-subtab="summary">SUMMARY</button>
        <button class="modal-sub-tab" data-subtab="stats">STATS</button>
        <button class="modal-sub-tab" data-subtab="lineups">LINEUPS</button>
      </div>
    `;
    contentHtml = renderFinishedMatchContent(match);
  }
  
  container.innerHTML = `
    ${headerHtml}
    <div class="modal-body">
      ${tabsHtml}
      <div class="modal-content-area">
        ${contentHtml}
      </div>
    </div>
  `;
  
  // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
  bindModalTabEvents(container, match, matchStatus);
}

// æ¸²æŸ“æœªå¼€èµ›æ¯”èµ›å†…å®¹
function renderScheduledMatchContent(match) {
  return `
    <div class="tab-content active" data-content="match">
      ${renderVenueInfo(match)}
      ${renderTeamForm(match)}
    </div>
    <div class="tab-content" data-content="odds">
      <div class="coming-soon">
        <i class="fa-solid fa-clock"></i>
        <h3>Coming Soon</h3>
        <p>Odds will be available closer to match time</p>
      </div>
    </div>
    <div class="tab-content" data-content="h2h">
      ${renderH2HTab(match)}
    </div>
    <div class="tab-content" data-content="standings">
      ${renderStandingsTab(match)}
    </div>
  `;
}
}

// æ¸²æŸ“è¿›è¡Œä¸­æ¯”èµ›å†…å®¹
function renderLiveMatchContent(match) {
  return `
    <div class="tab-content active" data-content="match">
      ${renderVenueInfo(match)}
      ${renderSummary(match)}
      <div class="watch-live-section">
        <a href="https://xoigac.tv/" target="_blank" class="watch-live-btn">
          <i class="fa-solid fa-play"></i>
          WATCH LIVE
        </a>
      </div>
      ${renderStats(match)}
    </div>
    <div class="tab-content" data-content="odds">
      <div class="coming-soon">
        <i class="fa-solid fa-clock"></i>
        <h3>Coming Soon</h3>
        <p>Live odds will be available soon</p>
      </div>
    </div>
    <div class="tab-content" data-content="h2h">
      ${renderH2HTab(match)}
    </div>
    <div class="tab-content" data-content="standings">
      ${renderStandingsTab(match)}
    </div>
  `;
}
}

// æ¸²æŸ“å·²ç»“æŸæ¯”èµ›å†…å®¹
function renderFinishedMatchContent(match) {
  return `
    <div class="tab-content active" data-content="match">
      <div class="sub-tab-content active" data-subcontent="summary">
        ${renderSummary(match)}
      </div>
      <div class="sub-tab-content" data-subcontent="stats">
        ${renderStats(match)}
      </div>
      <div class="sub-tab-content" data-subcontent="lineups">
        ${renderLineups(match)}
      </div>
    </div>
    <div class="tab-content" data-content="odds">
      <div class="coming-soon">
        <i class="fa-solid fa-clock"></i>
        <h3>Coming Soon</h3>
        <p>Historical odds data coming soon</p>
      </div>
    </div>
    <div class="tab-content" data-content="h2h">
      ${renderH2HTab(match)}
    </div>
    <div class="tab-content" data-content="standings">
      ${renderStandingsTab(match)}
    </div>
  `;
}
}

// æ¸²æŸ“æ¯”èµ›åŸºæœ¬ä¿¡æ¯
function renderMatchInfo(match) {
  const venue = match.fixture.venue;
  return `
    <div class="match-info-section">
      <h3><i class="fa-solid fa-info-circle"></i> Match Information</h3>
      <div class="info-grid">
        ${venue?.name ? `
          <div class="info-item">
            <span class="info-label">Stadium:</span>
            <span class="info-value">${escapeHtml(venue.name)}</span>
          </div>
        ` : ''}
        ${venue?.capacity ? `
          <div class="info-item">
            <span class="info-label">Capacity:</span>
            <span class="info-value">${venue.capacity.toLocaleString()}</span>
          </div>
        ` : ''}
        ${venue?.city ? `
          <div class="info-item">
            <span class="info-label">City:</span>
            <span class="info-value">${escapeHtml(venue.city)}</span>
          </div>
        ` : ''}
        <div class="info-item">
          <span class="info-label">Date:</span>
          <span class="info-value">${new Date(match.fixture.date).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Time:</span>
          <span class="info-value">${formatHHMM(match.fixture.date)}</span>
        </div>
      </div>
    </div>
  `;
}

// æ¸²æŸ“çƒé˜ŸçŠ¶æ€
function renderTeamForm(match) {
  return `
    <div class="team-form-section">
      <h3><i class="fa-solid fa-chart-line"></i> Team Form</h3>
      <div class="form-comparison">
        <div class="team-form">
          <div class="team-header">
            <img src="${match.teams.home.logo}" class="team-logo-sm">
            <span>${escapeHtml(match.teams.home.name)}</span>
          </div>
          <div class="form-dots">
            <!-- Form data would come from API -->
            <span class="form-dot form-w">W</span>
            <span class="form-dot form-w">W</span>
            <span class="form-dot form-d">D</span>
            <span class="form-dot form-w">W</span>
            <span class="form-dot form-l">L</span>
          </div>
        </div>
        <div class="team-form">
          <div class="team-header">
            <img src="${match.teams.away.logo}" class="team-logo-sm">
            <span>${escapeHtml(match.teams.away.name)}</span>
          </div>
          <div class="form-dots">
            <!-- Form data would come from API -->
            <span class="form-dot form-w">W</span>
            <span class="form-dot form-d">D</span>
            <span class="form-dot form-w">W</span>
            <span class="form-dot form-w">W</span>
            <span class="form-dot form-d">D</span>
          </div>
        </div>
      </div>
    </div>
  `;
}

// æ¸²æŸ“è§‚çœ‹ç›´æ’­æŒ‰é’®
function renderWatchLiveButton() {
  return `
    <div class="watch-live-section">
      <button class="watch-live-btn" onclick="window.open('https://xoigac.tv/', '_blank')">
        <i class="fa-solid fa-play"></i>
        WATCH LIVE
      </button>
    </div>
  `;
}

// ç»‘å®šæ¨¡æ€æ¡†æ ‡ç­¾é¡µäº‹ä»¶
function bindModalTabEvents(container, match, matchStatus) {
  // ä¸»æ ‡ç­¾é¡µåˆ‡æ¢
  container.querySelectorAll('.modal-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.dataset.tab;
      
      // åˆ‡æ¢æ ‡ç­¾é¡µæ¿€æ´»çŠ¶æ€
      container.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
      container.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.dataset.content === tabName);
      });
    });
  });
  
  // å­æ ‡ç­¾é¡µåˆ‡æ¢ï¼ˆä»…ç”¨äºå·²ç»“æŸçš„æ¯”èµ›ï¼‰
  container.querySelectorAll('.modal-sub-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const subTabName = tab.dataset.subtab;
      
      // åˆ‡æ¢å­æ ‡ç­¾é¡µæ¿€æ´»çŠ¶æ€
      container.querySelectorAll('.modal-sub-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // åˆ‡æ¢å­å†…å®¹æ˜¾ç¤º
      container.querySelectorAll('.sub-tab-content').forEach(content => {
        content.classList.toggle('active', content.dataset.subcontent === subTabName);
      });
    });
  });
}

// æ¸²æŸ“ç›´æ’­æ‘˜è¦
function renderLiveSummary(match) {
  if (!match.events || !match.events.length) {
    return `
      <div class="live-summary-section">
        <h3><i class="fa-solid fa-futbol"></i> Match Events</h3>
        <div class="no-events">No events recorded yet</div>
      </div>
    `;
  }

  // æŒ‰åŠåœºåˆ†ç»„äº‹ä»¶
  const firstHalfEvents = match.events.filter(e => e.time.elapsed <= 45);
  const secondHalfEvents = match.events.filter(e => e.time.elapsed > 45);

  return `
    <div class="live-summary-section">
      <h3><i class="fa-solid fa-futbol"></i> Match Events</h3>
      
      ${firstHalfEvents.length > 0 ? `
        <div class="half-events">
          <h4 class="half-title">1ST HALF</h4>
          <div class="events-list">
            ${firstHalfEvents.map(event => renderEventItem(event, match)).join('')}
          </div>
        </div>
      ` : ''}
      
      ${secondHalfEvents.length > 0 ? `
        <div class="half-events">
          <h4 class="half-title">2ND HALF</h4>
          <div class="events-list">
            ${secondHalfEvents.map(event => renderEventItem(event, match)).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

// æ¸²æŸ“å•ä¸ªäº‹ä»¶é¡¹
function renderEventItem(event, match) {
  const isHome = event.team?.id === match.teams.home.id;
  const playerName = event.player?.name || event.assist?.name || '';
  
  let icon = '';
  let eventClass = '';
  
  switch(event.type) {
    case 'Goal':
      icon = 'âš½';
      eventClass = 'goal-event';
      break;
    case 'Card':
      icon = event.detail === 'Yellow Card' ? 'ğŸŸ¨' : 'ğŸŸ¥';
      eventClass = event.detail === 'Yellow Card' ? 'yellow-card-event' : 'red-card-event';
      break;
    case 'subst':
      icon = 'ğŸ”„';
      eventClass = 'substitution-event';
      break;
    default:
      icon = 'âšª';
      eventClass = 'other-event';
  }

  return `
    <div class="event-item ${eventClass} ${isHome ? 'home-event' : 'away-event'}">
      <div class="event-time">${event.time.elapsed}'</div>
      <div class="event-icon">${icon}</div>
      <div class="event-details">
        <div class="event-player">${escapeHtml(playerName)}</div>
        <div class="event-type">${event.detail || event.type}</div>
      </div>
    </div>
  `;
}

// æ¸²æŸ“ç›´æ’­ç»Ÿè®¡æ•°æ®
function renderLiveStats(match) {
  if (!match.statistics || match.statistics.length < 2) {
    return `
      <div class="live-stats-section">
        <h3><i class="fa-solid fa-chart-bar"></i> Match Statistics</h3>
        <div class="no-stats">Statistics not available</div>
      </div>
    `;
  }

  const homeStats = match.statistics[0]?.statistics || [];
  const awayStats = match.statistics[1]?.statistics || [];

  return `
    <div class="live-stats-section">
      <h3><i class="fa-solid fa-chart-bar"></i> STATS</h3>
      
      <div class="stats-tabs">
        <button class="stats-tab active" data-period="match">MATCH</button>
        <button class="stats-tab" data-period="1st">1ST HALF</button>
        <button class="stats-tab" data-period="2nd">2ND HALF</button>
      </div>
      
      <div class="stats-content">
        <div class="stats-category">
          <h4>TOP STATS</h4>
          ${renderStatItem('Ball Possession', homeStats, awayStats)}
          ${renderStatItem('Total Shots', homeStats, awayStats)}
          ${renderStatItem('Shots on Goal', homeStats, awayStats)}
          ${renderStatItem('Corner Kicks', homeStats, awayStats)}
        </div>
        
        <div class="stats-category">
          <h4>SHOTS</h4>
          ${renderStatItem('Total Shots', homeStats, awayStats)}
          ${renderStatItem('Shots on Goal', homeStats, awayStats)}
          ${renderStatItem('Shots off Goal', homeStats, awayStats)}
        </div>
        
        <div class="stats-category">
          <h4>ATTACK</h4>
          ${renderStatItem('Corner Kicks', homeStats, awayStats)}
          ${renderStatItem('Yellow Cards', homeStats, awayStats)}
          ${renderStatItem('Red Cards', homeStats, awayStats)}
        </div>
      </div>
    </div>
  `;
}

// æ¸²æŸ“ç»Ÿè®¡é¡¹
function renderStatItem(statType, homeStats, awayStats) {
  const homeStat = homeStats.find(s => s.type === statType);
  const awayStat = awayStats.find(s => s.type === statType);
  
  const homeValue = homeStat?.value || 0;
  const awayValue = awayStat?.value || 0;
  
  // å¤„ç†ç™¾åˆ†æ¯”å€¼
  const homeNum = typeof homeValue === 'string' && homeValue.includes('%') 
    ? parseInt(homeValue) : parseInt(homeValue) || 0;
  const awayNum = typeof awayValue === 'string' && awayValue.includes('%') 
    ? parseInt(awayValue) : parseInt(awayValue) || 0;
  
  const total = homeNum + awayNum || 1;
  const homePercent = Math.round((homeNum / total) * 100);
  const awayPercent = 100 - homePercent;

  return `
    <div class="stat-row">
      <div class="stat-home-value">${homeValue}</div>
      <div class="stat-info">
        <div class="stat-name">${statType}</div>
        <div class="stat-bar">
          <div class="stat-bar-home" style="width: ${homePercent}%"></div>
          <div class="stat-bar-away" style="width: ${awayPercent}%"></div>
        </div>
      </div>
      <div class="stat-away-value">${awayValue}</div>
    </div>
  `;
}

// æ¸²æŸ“H2Hå†…å®¹
function renderH2HContent(match) {
  return `
    <div class="h2h-content">
      <h3><i class="fa-solid fa-history"></i> Head to Head</h3>
      <div class="h2h-placeholder">
        <p>Loading head-to-head data...</p>
        <div class="spinner"></div>
      </div>
    </div>
  `;
}

// æ¸²æŸ“ç§¯åˆ†æ¦œå†…å®¹
function renderStandingsContent(match) {
  return `
    <div class="standings-content">
      <h3><i class="fa-solid fa-trophy"></i> League Standings</h3>
      <div class="standings-placeholder">
        <p>Loading league standings...</p>
        <div class="spinner"></div>
      </div>
    </div>
  `;
}

// æ¸²æŸ“æ¯”èµ›æ‘˜è¦ï¼ˆå·²ç»“æŸï¼‰
function renderMatchSummary(match) {
  return renderSummary(match); // ä½¿ç”¨ç°æœ‰çš„renderSummaryå‡½æ•°
}

// æ¸²æŸ“è¯¦ç»†ç»Ÿè®¡ï¼ˆå·²ç»“æŸï¼‰
function renderDetailedStats(match) {
  if (!match.statistics || match.statistics.length < 2) {
    return '<div class="no-stats">Statistics not available</div>';
  }

  const homeStats = match.statistics[0]?.statistics || [];
  const awayStats = match.statistics[1]?.statistics || [];

  return `
    <div class="detailed-stats">
      <div class="stats-category">
        <h4>TOP STATS</h4>
        ${renderStatItem('Ball Possession', homeStats, awayStats)}
        ${renderStatItem('Total Shots', homeStats, awayStats)}
        ${renderStatItem('Shots on Goal', homeStats, awayStats)}
        ${renderStatItem('Corner Kicks', homeStats, awayStats)}
      </div>
      
      <div class="stats-category">
        <h4>SHOTS</h4>
        ${renderStatItem('Total Shots', homeStats, awayStats)}
        ${renderStatItem('Shots on Goal', homeStats, awayStats)}
        ${renderStatItem('Shots off Goal', homeStats, awayStats)}
        ${renderStatItem('Blocked Shots', homeStats, awayStats)}
      </div>
      
      <div class="stats-category">
        <h4>ATTACK</h4>
        ${renderStatItem('Attacks', homeStats, awayStats)}
        ${renderStatItem('Dangerous Attacks', homeStats, awayStats)}
        ${renderStatItem('Corner Kicks', homeStats, awayStats)}
      </div>
      
      <div class="stats-category">
        <h4>PASSES</h4>
        ${renderStatItem('Passes %', homeStats, awayStats)}
        ${renderStatItem('Passes accurate', homeStats, awayStats)}
        ${renderStatItem('Key Passes', homeStats, awayStats)}
      </div>
      
      <div class="stats-category">
        <h4>DEFENCE</h4>
        ${renderStatItem('Tackles', homeStats, awayStats)}
        ${renderStatItem('Blocks', homeStats, awayStats)}
        ${renderStatItem('Interceptions', homeStats, awayStats)}
      </div>
      
      <div class="stats-category">
        <h4>GOALKEEPING</h4>
        ${renderStatItem('Goalkeeper Saves', homeStats, awayStats)}
        ${renderStatItem('Goals conceded', homeStats, awayStats)}
      </div>
    </div>
  `;
}
async function getRecentResults(leagueId, limit = 10) {
  try {
    const currentDate = new Date();
    const results = [];
    
    // åªæŸ¥æ‰¾è¿‡å»14å¤©çš„æ¯”èµ›ï¼Œå‡å°‘APIè°ƒç”¨
    for (let i = 1; i <= 14; i++) {
      const date = new Date(currentDate);
      date.setDate(currentDate.getDate() - i);
      
      const dayFixtures = await loadFixturesByDateCached(date);
      const leagueResults = dayFixtures.filter(f => 
        f.league.id === leagueId && isFinished(f.fixture.status.short)
      );
      
      results.push(...leagueResults);
      
      if (results.length >= limit) break;
    }
    
    return results.slice(0, limit).sort((a, b) => 
      new Date(b.fixture.date) - new Date(a.fixture.date)
    );
  } catch (error) {
    console.error('Error getting recent results:', error);
    return [];
  }
}

// æŒ‰è½®æ¬¡åˆ†ç»„æ¯”èµ›
function groupFixturesByRound(fixtures) {
  const grouped = {};
  
  fixtures.forEach(fixture => {
    const round = fixture.league.round || 'Regular Season';
    if (!grouped[round]) {
      grouped[round] = [];
    }
    grouped[round].push(fixture);
  });
  
  return grouped;
}
async function loadLeagueResults(leagueId) {
  const container = document.getElementById("league-results");
  if (!container) return;
  
  container.innerHTML = '<div class="loading-placeholder">Loading results...</div>';
  
  try {
    // ä¼˜åŒ–ï¼šåªè·å–æœ€è¿‘30å¤©çš„æ¯”èµ›ç»“æœï¼Œè€Œä¸æ˜¯90å¤©
    const currentDate = new Date();
    const results = [];
    
    // åˆ†æ‰¹åŠ è½½ï¼Œå…ˆåŠ è½½æœ€è¿‘7å¤©
    for (let i = 0; i < 7; i++) {
      const date = new Date(currentDate);
      date.setDate(currentDate.getDate() - i);
      
      const dayFixtures = await loadFixturesByDateCached(date);
      const leagueFixtures = dayFixtures.filter(f => 
        f.league.id === leagueId && isFinished(f.fixture.status.short)
      );
      results.push(...leagueFixtures);
    }
    
    // å¦‚æœç»“æœå°‘äº10åœºï¼Œå†åŠ è½½æ›´å¤šå¤©æ•°
    if (results.length < 10) {
      for (let i = 7; i < 30; i++) {
        const date = new Date(currentDate);
        date.setDate(currentDate.getDate() - i);
        
        const dayFixtures = await loadFixturesByDateCached(date);
        const leagueFixtures = dayFixtures.filter(f => 
          f.league.id === leagueId && isFinished(f.fixture.status.short)
        );
        results.push(...leagueFixtures);
        
        if (results.length >= 20) break; // é™åˆ¶æœ€å¤š20åœºæ¯”èµ›
      }
    }
    
    // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    results.sort((a, b) => new Date(b.fixture.date) - new Date(a.fixture.date));
    
    if (results.length === 0) {
      container.innerHTML = '<div class="loading-placeholder">No recent results found</div>';
      return;
    }
    
    // æŒ‰è½®æ¬¡åˆ†ç»„ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    const resultsByRound = {};
    results.forEach(match => {
      const round = match.league.round || 'Regular Season';
      if (!resultsByRound[round]) {
        resultsByRound[round] = [];
      }
      resultsByRound[round].push(match);
    });
    
    // æŒ‰è½®æ¬¡ç¼–å·æ’åº
    const sortedRounds = Object.keys(resultsByRound).sort((a, b) => {
      const aNum = parseInt(a.match(/\d+/)?.[0] || '0');
      const bNum = parseInt(b.match(/\d+/)?.[0] || '0');
      return bNum - aNum; // é™åºæ’åˆ—
    });
    
    let html = `
      <div class="results-container">
        <div class="results-header">
          <h3><i class="fa-solid fa-history"></i> Recent Results</h3>
          <span class="results-count">${results.length} matches</span>
        </div>
        <div class="results-rounds">
    `;
    
    // æ¸²æŸ“æ¯ä¸ªè½®æ¬¡ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰5ä¸ªè½®æ¬¡ï¼‰
    sortedRounds.slice(0, 5).forEach(round => {
      const matches = resultsByRound[round];
      html += `
        <div class="results-round">
          <div class="round-header">
            <h4 class="round-title">${escapeHtml(round)}</h4>
            <span class="round-count">${matches.length} matches</span>
          </div>
          <div class="round-results">
            ${matches.slice(0, 8).map(match => `
              <div class="result-item" data-fixture-id="${match.fixture.id}" data-match-status="${match.fixture.status.short}">
                <div class="result-date">
                  ${new Date(match.fixture.date).toLocaleDateString('en-US', {
                    month: 'short', day: 'numeric'
                  })}
                </div>
                <div class="result-teams">
                  <div class="result-team home">
                    <img src="${match.teams.home.logo}" class="team-logo-sm">
                    <span class="team-name">${escapeHtml(match.teams.home.name)}</span>
                  </div>
                  <div class="result-score">
                    <span class="score-home ${(match.goals.home > match.goals.away) ? 'winner' : ''}">${match.goals.home}</span>
                    <span class="score-separator">-</span>
                    <span class="score-away ${(match.goals.away > match.goals.home) ? 'winner' : ''}">${match.goals.away}</span>
                  </div>
                  <div class="result-team away">
                    <img src="${match.teams.away.logo}" class="team-logo-sm">
                    <span class="team-name">${escapeHtml(match.teams.away.name)}</span>
                  </div>
                </div>
                <div class="result-status">${match.fixture.status.short}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    
    // ç»‘å®šResultsé¡µé¢çš„æ¯”èµ›ç‚¹å‡»äº‹ä»¶
    container.querySelectorAll('.result-item').forEach(item => {
      item.addEventListener('click', (e) => {
        // é˜²æ­¢åœ¨æ“ä½œæŒ‰é’®åŒºåŸŸç‚¹å‡»æ—¶è§¦å‘
        if (e.target.closest('.result-actions')) return;
        
        const fixtureId = parseInt(item.dataset.fixtureId);
        if (!fixtureId) return;
        
        // ä½¿ç”¨ç»Ÿä¸€çš„è¯¦æƒ…å±•å¼€å‡½æ•°
        openMatchDetails(fixtureId, item);
      });
    });
    
  } catch (error) {
    console.error('Error loading league results:', error);
    container.innerHTML = '<div class="loading-placeholder">Error loading results. Please try again.</div>';
  }
}

// åŠ è½½è”èµ›ç§¯åˆ†æ¦œ
async function loadLeagueStandings(leagueId) {
  const container = document.getElementById("league-standings");
  if (!container) return;
  
  container.innerHTML = '<div class="loading-placeholder">Loading standings...</div>';
  
  try {
    const standings = await apiGetJSON(`/api/standings?league=${leagueId}&season=2025`);
    
    if (!standings || !standings.length || !standings[0].league.standings) {
      container.innerHTML = '<div class="loading-placeholder">No standings data available</div>';
      return;
    }
    
    const standingsData = standings[0].league.standings[0]; // é€šå¸¸ç¬¬ä¸€ä¸ªæ˜¯ä¸»è¦ç§¯åˆ†æ¦œ
    
    const html = `
      <div class="standings-container">
        <div class="standings-header">
          <h3>League Table</h3>
          <span class="standings-season">Season 2025</span>
        </div>
        <div class="standings-table">
          <div class="standings-table-header">
            <div class="pos">#</div>
            <div class="team">Team</div>
            <div class="played">P</div>
            <div class="won">W</div>
            <div class="drawn">D</div>
            <div class="lost">L</div>
            <div class="goals">GF</div>
            <div class="goals">GA</div>
            <div class="goals">GD</div>
            <div class="points">Pts</div>
          </div>
          ${standingsData.map(team => `
            <div class="standings-row ${getPositionClass(team.rank)}">
              <div class="pos">${team.rank}</div>
              <div class="team">
                <img src="${team.team.logo}" class="team-logo-xs">
                <span class="team-name">${escapeHtml(team.team.name)}</span>
              </div>
              <div class="played">${team.all.played}</div>
              <div class="won">${team.all.win}</div>
              <div class="drawn">${team.all.draw}</div>
              <div class="lost">${team.all.lose}</div>
              <div class="goals">${team.all.goals.for}</div>
              <div class="goals">${team.all.goals.against}</div>
              <div class="goals ${team.goalsDiff >= 0 ? 'positive' : 'negative'}">${team.goalsDiff >= 0 ? '+' : ''}${team.goalsDiff}</div>
              <div class="points">${team.points}</div>
            </div>
          `).join('')}
        </div>
        <div class="standings-legend">
          <div class="legend-item champions">Champions League</div>
          <div class="legend-item europa">Europa League</div>
          <div class="legend-item relegation">Relegation</div>
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading standings:', error);
    container.innerHTML = '<div class="loading-placeholder">Error loading standings</div>';
  }
}

// è·å–ç§¯åˆ†æ¦œä½ç½®æ ·å¼ç±»
function getPositionClass(rank) {
  if (rank <= 4) return 'champions';
  if (rank <= 6) return 'europa';
  if (rank >= 18) return 'relegation';
  return '';
}

// åŠ è½½H2Hæ•°æ®
async function loadLeagueH2H(leagueId) {
  const container = document.getElementById("league-h2h");
  if (!container) return;
  
  container.innerHTML = `
    <div class="h2h-container">
      <div class="h2h-header">
        <h3>Head to Head Analysis</h3>
        <p>Select two teams to compare their head-to-head record</p>
      </div>
      <div class="h2h-selector">
        <select id="h2h-team1" class="h2h-team-select">
          <option value="">Select Team 1</option>
        </select>
        <div class="h2h-vs">VS</div>
        <select id="h2h-team2" class="h2h-team-select">
          <option value="">Select Team 2</option>
        </select>
        <button id="h2h-compare" class="h2h-compare-btn">Compare</button>
      </div>
      <div id="h2h-results" class="h2h-results">
        <div class="loading-placeholder">Select two teams to see their head-to-head record</div>
      </div>
    </div>
  `;
  
  // åŠ è½½è”èµ›ä¸­çš„çƒé˜Ÿ
  loadLeagueTeams(leagueId);
}

// åŠ è½½è”èµ›çƒé˜Ÿåˆ—è¡¨
async function loadLeagueTeams(leagueId) {
  try {
    const teams = await apiGetJSON(`/api/teams?league=${leagueId}&season=2025`);
    
    if (!teams || !teams.length) return;
    
    const team1Select = document.getElementById('h2h-team1');
    const team2Select = document.getElementById('h2h-team2');
    
    if (!team1Select || !team2Select) return;
    
    const teamOptions = teams.map(teamData => {
      const team = teamData.team;
      return `<option value="${team.id}">${escapeHtml(team.name)}</option>`;
    }).join('');
    
    team1Select.innerHTML = '<option value="">Select Team 1</option>' + teamOptions;
    team2Select.innerHTML = '<option value="">Select Team 2</option>' + teamOptions;
    
    // ç»‘å®šæ¯”è¾ƒæŒ‰é’®äº‹ä»¶
    const compareBtn = document.getElementById('h2h-compare');
    if (compareBtn) {
      compareBtn.addEventListener('click', () => {
        const team1Id = team1Select.value;
        const team2Id = team2Select.value;
        
        if (team1Id && team2Id && team1Id !== team2Id) {
          loadH2HData(team1Id, team2Id);
        }
      });
    }
    
  } catch (error) {
    console.error('Error loading teams:', error);
  }
}

// åŠ è½½ä¸¤é˜Ÿå¯¹æˆ˜æ•°æ®
async function loadH2HData(team1Id, team2Id) {
  const resultsContainer = document.getElementById('h2h-results');
  if (!resultsContainer) return;
  
  resultsContainer.innerHTML = '<div class="loading-placeholder">Loading head-to-head data...</div>';
  
  try {
    // è¿™é‡Œå¯ä»¥è°ƒç”¨H2H APIï¼Œä½†ç”±äºAPIé™åˆ¶ï¼Œæˆ‘ä»¬ç”¨ç°æœ‰æ•°æ®æ¨¡æ‹Ÿ
    const currentDate = new Date();
    const dates = [];
    for (let i = 0; i < 30; i++) {
      const date = new Date(currentDate);
      date.setDate(currentDate.getDate() - i);
      dates.push(toYMD(date));
    }
    
    let h2hMatches = [];
    for (const date of dates) {
      const fixtures = await loadFixturesByDateCached(new Date(date));
      const matches = fixtures.filter(f => 
        (f.teams.home.id == team1Id && f.teams.away.id == team2Id) ||
        (f.teams.home.id == team2Id && f.teams.away.id == team1Id)
      );
      h2hMatches = h2hMatches.concat(matches);
    }
    
    if (h2hMatches.length === 0) {
      resultsContainer.innerHTML = '<div class="loading-placeholder">No recent matches found between these teams</div>';
      return;
    }
    
    // ç»Ÿè®¡æ•°æ®
    let team1Wins = 0, team2Wins = 0, draws = 0;
    h2hMatches.forEach(match => {
      if (isFinished(match.fixture.status.short)) {
        const team1IsHome = match.teams.home.id == team1Id;
        const team1Goals = team1IsHome ? match.goals.home : match.goals.away;
        const team2Goals = team1IsHome ? match.goals.away : match.goals.home;
        
        if (team1Goals > team2Goals) team1Wins++;
        else if (team2Goals > team1Goals) team2Wins++;
        else draws++;
      }
    });
    
    const team1Name = h2hMatches[0].teams.home.id == team1Id ? 
      h2hMatches[0].teams.home.name : h2hMatches[0].teams.away.name;
    const team2Name = h2hMatches[0].teams.home.id == team2Id ? 
      h2hMatches[0].teams.home.name : h2hMatches[0].teams.away.name;
    
    const html = `
      <div class="h2h-stats">
        <div class="h2h-summary">
          <div class="h2h-team-stat">
            <div class="h2h-team-name">${escapeHtml(team1Name)}</div>
            <div class="h2h-wins">${team1Wins}</div>
          </div>
          <div class="h2h-draws">
            <div class="h2h-draws-label">Draws</div>
            <div class="h2h-draws-count">${draws}</div>
          </div>
          <div class="h2h-team-stat">
            <div class="h2h-team-name">${escapeHtml(team2Name)}</div>
            <div class="h2h-wins">${team2Wins}</div>
          </div>
        </div>
        <div class="h2h-matches">
          <h4>Recent Matches</h4>
          ${h2hMatches.slice(0, 10).map(match => `
            <div class="h2h-match">
              <div class="h2h-match-date">
                ${new Date(match.fixture.date).toLocaleDateString('en-US', {
                  month: 'short', day: 'numeric', year: 'numeric'
                })}
              </div>
              <div class="h2h-match-teams">
                <span class="h2h-home">${escapeHtml(match.teams.home.name)}</span>
                <span class="h2h-score">${match.goals.home} - ${match.goals.away}</span>
                <span class="h2h-away">${escapeHtml(match.teams.away.name)}</span>
              </div>
              <div class="h2h-match-status">${match.fixture.status.long}</div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    
    resultsContainer.innerHTML = html;
    
  } catch (error) {
    console.error('Error loading H2H data:', error);
    resultsContainer.innerHTML = '<div class="loading-placeholder">Error loading head-to-head data</div>';
  }
}

// ---------- Load News Categories for Navigation ----------
async function loadNavCategories() {
  try {
    await window.CONFIG_READY;
    const apiBase = window.APP_CONFIG?.adminApiUrl || 'http://localhost:8080';
    const res = await fetch(`${apiBase}/api/public/categories`);
    const data = await res.json();
    if (data.success && data.data.length > 0) {
      const nav = document.getElementById('main-nav');
      if (nav) {
        if (nav.getAttribute('data-managed-by') === 'articles-page') {
          return;
        }

        const normalizePathname = (pathname) => {
          const p = String(pathname || '/');
          if (p !== '/' && p.endsWith('/')) return p.slice(0, -1);
          return p;
        };

        const currentPath = normalizePathname(window.location.pathname);

        nav.innerHTML =
          `<a href="/" class="text-gray-500 hover:text-white transition-colors" style="${currentPath === '/' ? 'color:var(--green)' : ''}">Football</a>` +
          data.data.map(c => {
            const href = `/${c.slug}`;
            const isActive = normalizePathname(href) === currentPath;
            return `<a href="${href}" class="text-gray-500 hover:text-white transition-colors" style="${isActive ? 'color:var(--green)' : ''}">${c.name}</a>`;
          }).join('');
      }
      
      // Update footer category links (insert after News Feed)
      const footerCatLinks = document.getElementById('footer-category-links');
      if (footerCatLinks) {
        footerCatLinks.innerHTML = data.data.slice(0, 4).map(c => 
          `<a href="/${c.slug}" class="footer-link">${c.name}</a>`
        ).join('');
      }
      
      // Remove the old footer-categories section
      const oldFooterCats = document.getElementById('footer-categories');
      if (oldFooterCats) {
        oldFooterCats.style.display = 'none';
      }
    }
  } catch (err) {
    console.error('Load nav categories error:', err);
  }
}

// ---------- Init ----------
async function init() {
  // Clock and categories are now loaded in loadComponents()
  bindEvents();
  await refreshAll();
}

init(); // âœ…ã€å°±æ˜¯ç¼ºè¿™ä¸€è¡Œã€‘

setInterval(() => {
  const leaguePage = document.getElementById("league-page");
  const isLeaguePageVisible = leaguePage && !leaguePage.classList.contains("hidden");

  if (!isLeaguePageVisible) {
    refreshAll();
    return;
  }

  loadLive().then(live => {
    state.lastLive = live || [];
    updateLiveBadge(state.lastLive);

    if (state.selectedLeagueId) {
      const summaryPanel = document.getElementById("league-summary");
      if (summaryPanel && summaryPanel.classList.contains("active")) {
        renderLeagueSummary(state.selectedLeagueId);
      }
    }
  });
}, 30000); // æ”¹ä¸º30ç§’åˆ·æ–°ä¸€æ¬¡

// é¢å¤–æ·»åŠ Liveæ•°æ®çš„é«˜é¢‘åˆ·æ–°ï¼ˆä»…æ›´æ–°Liveæ¯”èµ›ï¼‰
setInterval(() => {
  loadLive().then(live => {
    if (live && live.length > 0) {
      state.lastLive = live;
      updateLiveBadge(state.lastLive);
      renderFeaturedLive(state.lastLive);
      
      // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æ‰€æœ‰æ¯”èµ›æˆ–Liveæ ‡ç­¾ï¼Œä¹Ÿæ›´æ–°æ¯”èµ›åˆ—è¡¨
      if (state.tab === 'all' || state.tab === 'live') {
        renderFixtures(state.lastFixtures, state.lastLive);
      }
    }
  });
}, 15000); // Liveæ•°æ®æ¯15ç§’åˆ·æ–°ä¸€æ¬¡