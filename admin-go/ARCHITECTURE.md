# 足球数据系统架构

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端应用 (bongdaha2)                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  main.js / fixtures.js / live.js                         │  │
│  │  - 显示赛事列表                                           │  │
│  │  - 显示直播比赛                                           │  │
│  │  - 显示积分榜                                             │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                    HTTP 请求 (GET/POST)
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Go 后端 API (admin-go)                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  handlers/polling.go                                     │  │
│  │  - 定时任务调度                                           │  │
│  │  - API 数据同步                                           │  │
│  │  - 错误处理和重试                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                             │                                    │
│                    ┌────────┴────────┐                           │
│                    │                 │                           │
│                    ▼                 ▼                           │
│  ┌──────────────────────┐  ┌──────────────────────┐             │
│  │  API 端点            │  │  定时任务            │             │
│  │  /api/fixtures       │  │  syncLeagues()       │             │
│  │  /api/standings      │  │  syncTeams()         │             │
│  │  /api/top-scorers    │  │  syncFixtures()      │             │
│  │  /api/live           │  │  syncLiveFixtures()  │             │
│  │                      │  │  syncStandings()     │             │
│  │                      │  │  syncTopScorers()    │             │
│  └──────────────────────┘  └──────────────────────┘             │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                    MySQL 数据库操作
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    MySQL 数据库 (sports_db)                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  核心表                                                   │  │
│  │  ├─ leagues (联赛)                                        │  │
│  │  ├─ teams (球队)                                          │  │
│  │  ├─ fixtures (赛事)                                       │  │
│  │  ├─ fixture_events (赛事事件)                             │  │
│  │  ├─ standings (积分榜)                                    │  │
│  │  ├─ top_scorers (射手榜)                                  │  │
│  │  └─ api_sync_logs (同步日志)                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                    HTTP 请求 (GET)
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│              外部 API (api-football.com)                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  /leagues - 获取联赛列表                                  │  │
│  │  /teams - 获取球队信息                                    │  │
│  │  /fixtures - 获取赛事信息                                 │  │
│  │  /fixtures?live=all - 获取直播赛事                        │  │
│  │  /standings - 获取积分榜                                  │  │
│  │  /players/topscorers - 获取射手榜                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📊 数据流向

### 1. 初始化流程

```
启动 Go 服务器
    ↓
加载配置 (config.Load())
    ↓
初始化数据库 (models.InitDB())
    ↓
启动定时任务 (handlers.InitPolling())
    ↓
创建 Gin 路由
    ↓
监听端口
```

### 2. 定时任务流程

```
定时任务触发
    ↓
调用外部 API
    ↓
解析 JSON 响应
    ↓
检查数据库中是否存在
    ↓
插入或更新数据
    ↓
记录同步日志
    ↓
完成
```

### 3. 用户请求流程

```
用户请求 /api/fixtures
    ↓
Go 后端接收请求
    ↓
从数据库查询数据
    ↓
返回 JSON 响应
    ↓
前端接收数据
    ↓
渲染页面
```

---

## ⏰ 定时任务时间线

```
时间轴（24 小时）
├─ 01:00 ─ syncTeams (月初)
├─ 02:00 ─ syncLeagues (周一)
├─ 03:00 ─ syncFixtures
├─ 03:00 ─ syncStandings
├─ 03:00 ─ syncTopScorers
├─ 05:00 ─ (空闲)
├─ 10:00 ─ (空闲)
├─ 15:00 ─ (空闲)
├─ 21:00 ─ syncStandings
└─ 每 5 分钟 ─ syncLiveFixtures (实时)
```

---

## 🔄 数据同步周期

### 周期 1：每周（周一）

```
周一 02:00
    ↓
syncLeagues()
    ↓
获取所有联赛信息
    ↓
更新 leagues 表
    ↓
记录日志
```

### 周期 2：每月（月初）

```
月初 01:00
    ↓
syncTeams()
    ↓
获取所有球队信息
    ↓
更新 teams 表
    ↓
记录日志
```

### 周期 3：每天（凌晨 03:00）

```
凌晨 03:00
    ├─ syncFixtures()
    │   ├─ 获取今天的比赛
    │   └─ 更新 fixtures 表
    │
    ├─ syncStandings()
    │   ├─ 获取主要联赛的积分榜
    │   └─ 更新 standings 表
    │
    └─ syncTopScorers()
        ├─ 获取主要联赛的射手榜
        └─ 更新 top_scorers 表
```

### 周期 4：每天晚上（21:00）

```
晚上 21:00
    ↓
syncStandings()
    ↓
获取主要联赛的积分榜
    ↓
更新 standings 表
    ↓
记录日志
```

### 周期 5：实时（每 5 分钟）

```
每 5 分钟
    ↓
syncLiveFixtures()
    ↓
获取进行中的比赛
    ↓
更新 fixtures 表
    ↓
获取比赛事件
    ↓
更新 fixture_events 表
    ↓
记录日志
```

---

## 📈 API 调用成本

### 按时间分布

```
每月 API 调用分布（赛季期间）

周一 02:00:  1 次 (leagues)
月初 01:00:  1 次 (teams)
每天 03:00:  3 次 (fixtures + standings + scorers)
每天 21:00:  1 次 (standings)
每 5 分钟:  288 次 (live fixtures)

总计: 1 + 1 + 3×30 + 1×30 + 288×30 = 8,762 次/月
```

### 按任务分布

```
syncLeagues:      1 次/月 (0.03%)
syncTeams:        1 次/月 (0.03%)
syncFixtures:    30 次/月 (0.34%)
syncLiveFixtures: 8,640 次/月 (98.6%)
syncStandings:   60 次/月 (0.68%)
syncTopScorers:  30 次/月 (0.34%)
```

---

## 🎯 性能指标

### 响应时间对比

```
优化前（无缓存）:
  用户请求 → 调用外部 API → 返回数据
  响应时间: 500-2000ms

优化后（有数据库缓存）:
  用户请求 → 从数据库读取 → 返回数据
  响应时间: 50-100ms

性能提升: 10-20 倍
```

### 数据库查询性能

```
查询类型          查询时间    说明
─────────────────────────────────────
SELECT fixtures   10-50ms    有索引
SELECT standings  10-50ms    有索引
SELECT teams      5-20ms     小表
SELECT leagues    5-20ms     小表
```

---

## 🔐 数据一致性

### 事务处理

```
同步操作
    ↓
开始事务
    ↓
删除旧数据（可选）
    ↓
插入新数据
    ↓
提交事务
    ↓
记录日志
```

### 错误处理

```
API 调用失败
    ↓
记录错误日志
    ↓
等待指数退避时间
    ↓
重试（最多 3 次）
    ↓
如果仍然失败，发送告警
```

---

## 📊 表关系

### 主键和外键

```
leagues (主表)
    ↓
    ├─ fixtures (外键: league_id)
    │   ├─ fixture_events (外键: fixture_id)
    │   └─ standings (外键: league_id)
    │
    └─ top_scorers (外键: league_id)

teams (独立表)
    ├─ fixtures (关联: home_team_id, away_team_id)
    ├─ standings (外键: team_id)
    └─ top_scorers (外键: team_id)
```

### 索引策略

```
表名              索引字段              用途
─────────────────────────────────────────────────
leagues          api_id, type          快速查找
teams            api_id, name          快速查找
fixtures         api_id, league_id,    快速查找和范围查询
                 fixture_date, status
standings        league_id, season,    快速查找和排序
                 rank
top_scorers      league_id, season,    快速查找和排序
                 goals
```

---

## 🚀 扩展性

### 水平扩展

```
当前架构（单服务器）:
  Go 后端 → MySQL 数据库

扩展后（多服务器）:
  Go 后端 1 ─┐
  Go 后端 2 ─┼─ 负载均衡器 ─ MySQL 主从复制
  Go 后端 3 ─┘
```

### 缓存层

```
当前架构:
  用户请求 → Go 后端 → MySQL

扩展后（添加 Redis）:
  用户请求 → Go 后端 → Redis 缓存 → MySQL
```

---

## 📝 监控和告警

### 监控指标

```
指标                  阈值        告警
─────────────────────────────────────────
同步失败率            > 10%       发送告警
执行时间              > 5000ms    发送告警
数据延迟              > 1 小时    发送告警
API 错误率            > 10%       发送告警
数据库连接数          > 80%       发送告警
```

### 日志记录

```
api_sync_logs 表记录:
  - sync_type: 同步类型
  - status: 成功/失败
  - records_synced: 同步记录数
  - execution_time_ms: 执行时间
  - error_message: 错误信息
  - created_at: 创建时间
```

---

## 🔄 更新流程

### 完整的数据更新流程

```
1. 定时任务触发
   ↓
2. 调用外部 API
   ├─ 成功 → 继续
   └─ 失败 → 重试 3 次 → 记录错误 → 结束
   ↓
3. 解析 JSON 响应
   ├─ 成功 → 继续
   └─ 失败 → 记录错误 → 结束
   ↓
4. 开始数据库事务
   ↓
5. 检查数据是否存在
   ├─ 存在 → 更新
   └─ 不存在 → 插入
   ↓
6. 提交事务
   ├─ 成功 → 继续
   └─ 失败 → 回滚 → 记录错误 → 结束
   ↓
7. 记录同步日志
   ↓
8. 完成
```

---

## 📚 相关文件

- `main.go` - 主程序入口
- `handlers/polling.go` - 定时任务实现
- `models/db.go` - 数据库初始化
- `create_football_tables.sql` - 表创建脚本
- `DATABASE_SCHEMA_PLAN.md` - 数据库设计
- `IMPLEMENTATION_GUIDE.md` - 实现指南
- `POLLING_SCHEDULE.md` - 调度表

