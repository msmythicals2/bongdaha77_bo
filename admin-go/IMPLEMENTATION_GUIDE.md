# è¶³çƒæ•°æ®åº“å®ç°æŒ‡å—

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ•°æ®åº“è¡¨

åœ¨ä½ çš„MySQLæ•°æ®åº“ä¸­è¿è¡Œ `create_football_tables.sql` è„šæœ¬ï¼š

```bash
mysql -u [username] -p [database_name] < create_football_tables.sql
```

æˆ–è€…åœ¨MySQLå®¢æˆ·ç«¯ä¸­ç›´æ¥æ‰§è¡Œæ–‡ä»¶å†…å®¹ã€‚

### ç¬¬äºŒæ­¥ï¼šéªŒè¯è¡¨åˆ›å»º

```sql
SHOW TABLES;
-- åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ–°è¡¨ï¼š
-- leagues, teams, fixtures, fixture_events, standings, top_scorers, api_sync_logs
```

### ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡

å®šæ—¶ä»»åŠ¡å·²ç»åœ¨ `main.go` ä¸­å¯åŠ¨ï¼Œåªéœ€ç¡®ä¿ï¼š

1. `.env` æ–‡ä»¶ä¸­æœ‰ `FOOTBALL_API_KEY`
2. è¿è¡Œ Go æœåŠ¡å™¨

```bash
go run main.go
```

---

## ğŸ”„ æ›´æ–°é¢‘ç‡è¯¦è§£

### 1. **Leaguesï¼ˆè”èµ›ï¼‰- æ¯å‘¨ 1 æ¬¡**

**æ—¶é—´**: å‘¨ä¸€ 02:00

**åŸå› **:
- è”èµ›ä¿¡æ¯å˜åŒ–ä¸é¢‘ç¹
- ä¸»è¦æ˜¯æ–°èµ›å­£å¼€å§‹æ—¶æ›´æ–°
- èŠ‚çœ API é…é¢

**åŒ…å«æ•°æ®**:
- è”èµ›åç§°ã€ç±»å‹ï¼ˆLeague/Cup/Internationalï¼‰
- å›½å®¶ã€logoç­‰

---

### 2. **Teamsï¼ˆçƒé˜Ÿï¼‰- æ¯æœˆ 1 æ¬¡**

**æ—¶é—´**: æœˆåˆ 01:00

**åŸå› **:
- çƒé˜ŸåŸºæœ¬ä¿¡æ¯å¾ˆå°‘å˜åŒ–
- ä¸»è¦æ˜¯çƒé˜Ÿæˆç«‹ã€ä¸»åœºç­‰ä¿¡æ¯
- èŠ‚çœ API é…é¢

**åŒ…å«æ•°æ®**:
- çƒé˜Ÿåç§°ã€ä»£ç ã€å›½å®¶
- ä¸»åœºåç§°ã€å®¹é‡ç­‰

---

### 3. **Fixturesï¼ˆèµ›äº‹ï¼‰- æ¯å¤© 1 æ¬¡ + å®æ—¶**

**æ—¶é—´**: 
- æœªå¼€å§‹/å·²ç»“æŸ: å‡Œæ™¨ 03:00ï¼ˆæ¯å¤© 1 æ¬¡ï¼‰
- è¿›è¡Œä¸­: æ¯ 5 åˆ†é’Ÿ

**åŸå› **:
- æœªå¼€å§‹çš„æ¯”èµ›ä¿¡æ¯ç›¸å¯¹ç¨³å®š
- è¿›è¡Œä¸­çš„æ¯”èµ›éœ€è¦å®æ—¶æ›´æ–°
- å·²ç»“æŸçš„æ¯”èµ›éœ€è¦æœ€ç»ˆæ•°æ®

**åŒ…å«æ•°æ®**:
- æ¯”èµ›æ—¶é—´ã€çƒé˜Ÿã€æ¯”åˆ†
- æ¯”èµ›çŠ¶æ€ï¼ˆNS/TBD/1H/HT/2H/FTç­‰ï¼‰

---

### 4. **Fixture Eventsï¼ˆèµ›äº‹äº‹ä»¶ï¼‰- æ¯ 5 åˆ†é’Ÿ**

**æ—¶é—´**: å®æ—¶ï¼ˆä»…æ›´æ–°è¿›è¡Œä¸­çš„æ¯”èµ›ï¼‰

**åŸå› **:
- è¿›çƒã€é»„ç‰Œç­‰äº‹ä»¶éœ€è¦å®æ—¶æ›´æ–°
- åªåœ¨æ¯”èµ›è¿›è¡Œä¸­æ—¶è°ƒç”¨

**åŒ…å«æ•°æ®**:
- è¿›çƒã€é»„ç‰Œã€çº¢ç‰Œã€æ¢äººç­‰äº‹ä»¶
- äº‹ä»¶æ—¶é—´ã€çƒå‘˜ä¿¡æ¯

---

### 5. **Standingsï¼ˆç§¯åˆ†æ¦œï¼‰- æ¯å¤© 2 æ¬¡**

**æ—¶é—´**: 03:00 å’Œ 21:00

**åŸå› **:
- æ¯åœºæ¯”èµ›åç§¯åˆ†æ¦œä¼šæ›´æ–°
- æ—©æ™¨æ›´æ–°å‰ä¸€å¤©çš„æ¯”èµ›ç»“æœ
- æ™šä¸Šæ›´æ–°å½“å¤©çš„æ¯”èµ›ç»“æœ

**åŒ…å«æ•°æ®**:
- çƒé˜Ÿæ’åã€ç§¯åˆ†ã€èƒœè´Ÿå¹³
- è¿›çƒæ•°ã€å¤±çƒæ•°ç­‰

---

### 6. **Top Scorersï¼ˆå°„æ‰‹æ¦œï¼‰- æ¯å¤© 1 æ¬¡**

**æ—¶é—´**: å‡Œæ™¨ 03:00

**åŸå› **:
- æ¯åœºæ¯”èµ›åå°„æ‰‹æ¦œä¼šæ›´æ–°
- ä¸€å¤©ä¸€æ¬¡è¶³ä»¥æ»¡è¶³éœ€æ±‚

**åŒ…å«æ•°æ®**:
- çƒå‘˜åç§°ã€è¿›çƒæ•°ã€åŠ©æ”»æ•°
- çƒé˜Ÿä¿¡æ¯

---

## ğŸ“Š API é…é¢åˆ†æ

### å½“å‰é…é¢ï¼ˆå‡è®¾å…è´¹è®¡åˆ’ï¼‰
- æ¯æœˆ 100 æ¬¡è¯·æ±‚

### ä¼˜åŒ–åçš„è°ƒç”¨æ¬¡æ•°

```
æ¯å‘¨:
  - Leagues: 1 æ¬¡

æ¯å¤©:
  - Fixtures: 1 æ¬¡
  - Standings: 2 æ¬¡
  - Top Scorers: 1 æ¬¡
  å°è®¡: 4 æ¬¡/å¤©

æ¯ 5 åˆ†é’Ÿï¼ˆä»…èµ›å­£æœŸé—´ï¼‰:
  - Live Fixtures: 288 æ¬¡/å¤©ï¼ˆ24å°æ—¶ Ã— 12æ¬¡/å°æ—¶ï¼‰

æ€»è®¡ï¼ˆèµ›å­£æœŸé—´ï¼‰:
  - 1 + 4 + 288 = 293 æ¬¡/å¤©
  - 293 Ã— 30 = 8,790 æ¬¡/æœˆ

æ€»è®¡ï¼ˆéèµ›å­£æœŸé—´ï¼‰:
  - 1 + 4 = 5 æ¬¡/å¤©
  - 5 Ã— 30 = 150 æ¬¡/æœˆ
```

### ä¼˜åŒ–å»ºè®®

1. **åªåœ¨èµ›å­£æœŸé—´å¯ç”¨ Live è½®è¯¢**
   ```go
   // åœ¨ InitPolling ä¸­æ·»åŠ æ¡ä»¶
   if isSeasonActive() {
       go scheduleEveryNMinutes(5, syncLiveFixtures)
   }
   ```

2. **å‡çº§åˆ°ä»˜è´¹è®¡åˆ’**
   - å…è´¹: 100 æ¬¡/æœˆ
   - åŸºç¡€: 1,000 æ¬¡/æœˆ
   - ä¸“ä¸š: 10,000 æ¬¡/æœˆ

3. **ä½¿ç”¨ WebSocket å®æ—¶æ¨é€**ï¼ˆå¦‚æœAPIæ”¯æŒï¼‰
   - å‡å°‘è½®è¯¢æ¬¡æ•°
   - å®æ—¶è·å–æ•°æ®

---

## ğŸ› ï¸ å®ç°æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è¡¨ç»“æ„ï¼ˆå·²å®Œæˆï¼‰
- âœ… åˆ›å»º `leagues`, `teams`, `fixtures` è¡¨
- âœ… åˆ›å»º `api_sync_logs` è¡¨ç”¨äºç›‘æ§
- âœ… åˆ›å»ºå®šæ—¶ä»»åŠ¡æ¡†æ¶

### ç¬¬äºŒé˜¶æ®µï¼šå®ç°æ•°æ®åŒæ­¥ï¼ˆéœ€è¦å®Œæˆï¼‰

#### 2.1 å®ç° `syncLeagues()` å‡½æ•°

```go
func syncLeagues() {
    // 1. è°ƒç”¨ API è·å–æ‰€æœ‰è”èµ›
    // 2. è§£æ JSON å“åº”
    // 3. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨
    // 4. æ’å…¥æˆ–æ›´æ–°æ•°æ®
    // 5. è®°å½•åŒæ­¥æ—¥å¿—
}
```

#### 2.2 å®ç° `syncTeams()` å‡½æ•°

```go
func syncTeams() {
    // 1. ä» leagues è¡¨è·å–æ‰€æœ‰è”èµ› ID
    // 2. å¯¹æ¯ä¸ªè”èµ›è°ƒç”¨ API è·å–çƒé˜Ÿ
    // 3. è§£æå¹¶ä¿å­˜åˆ° teams è¡¨
    // 4. è®°å½•åŒæ­¥æ—¥å¿—
}
```

#### 2.3 å®ç° `syncFixtures()` å‡½æ•°

```go
func syncFixtures() {
    // 1. è·å–ä»Šå¤©çš„æ—¥æœŸ
    // 2. è°ƒç”¨ API è·å–ä»Šå¤©çš„æ¯”èµ›
    // 3. è§£æå¹¶ä¿å­˜åˆ° fixtures è¡¨
    // 4. è®°å½•åŒæ­¥æ—¥å¿—
}
```

### ç¬¬ä¸‰é˜¶æ®µï¼šå®ç°é«˜çº§åŠŸèƒ½

#### 3.1 å®ç° `syncLiveFixtures()` å‡½æ•°
- è·å–è¿›è¡Œä¸­çš„æ¯”èµ›
- æ›´æ–°æ¯”åˆ†å’ŒçŠ¶æ€
- è·å–æ¯”èµ›äº‹ä»¶

#### 3.2 å®ç° `syncStandings()` å‡½æ•°
- è·å–ä¸»è¦è”èµ›çš„ç§¯åˆ†æ¦œ
- æ›´æ–° standings è¡¨

#### 3.3 å®ç° `syncTopScorers()` å‡½æ•°
- è·å–ä¸»è¦è”èµ›çš„å°„æ‰‹æ¦œ
- æ›´æ–° top_scorers è¡¨

### ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–å’Œç›‘æ§

#### 4.1 é”™è¯¯å¤„ç†å’Œé‡è¯•
```go
func makeAPIRequestWithRetry(url string, maxRetries int) (*http.Response, error) {
    var resp *http.Response
    var err error
    
    for i := 0; i < maxRetries; i++ {
        resp, err = makeAPIRequest(url)
        if err == nil && resp.StatusCode == 200 {
            return resp, nil
        }
        
        if i < maxRetries-1 {
            time.Sleep(time.Duration(math.Pow(2, float64(i))) * time.Second)
        }
    }
    
    return resp, err
}
```

#### 4.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨æ‰¹é‡æ’å…¥è€Œä¸æ˜¯é€æ¡æ’å…¥
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- æ·»åŠ é€‚å½“çš„ç´¢å¼•

#### 4.3 ç›‘æ§å’Œå‘Šè­¦
- ç›‘æ§ API è°ƒç”¨å¤±è´¥
- ç›‘æ§æ•°æ®åº“å†™å…¥å¤±è´¥
- å‘é€å‘Šè­¦é€šçŸ¥

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ‰¹é‡æ’å…¥

```go
// ä¸å¥½çš„åšæ³•ï¼šé€æ¡æ’å…¥
for _, fixture := range fixtures {
    db.Exec("INSERT INTO fixtures ...")
}

// å¥½çš„åšæ³•ï¼šæ‰¹é‡æ’å…¥
query := "INSERT INTO fixtures (...) VALUES "
values := []interface{}{}
for i, fixture := range fixtures {
    if i > 0 {
        query += ", "
    }
    query += "(?, ?, ?, ...)"
    values = append(values, fixture.ApiID, fixture.LeagueID, ...)
}
db.Exec(query, values...)
```

### 2. ä½¿ç”¨äº‹åŠ¡

```go
tx, _ := db.Begin()
defer tx.Rollback()

// æ‰§è¡Œå¤šä¸ªæ“ä½œ
tx.Exec("INSERT INTO fixtures ...")
tx.Exec("UPDATE standings ...")

tx.Commit()
```

### 3. æ·»åŠ ç¼“å­˜

```go
// ç¼“å­˜æœ€è¿‘çš„åŒæ­¥ç»“æœ
var lastSyncTime map[string]time.Time
var lastSyncData map[string]interface{}

func getCachedData(key string) interface{} {
    if time.Since(lastSyncTime[key]) < 5*time.Minute {
        return lastSyncData[key]
    }
    return nil
}
```

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹åŒæ­¥æ—¥å¿—

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„åŒæ­¥è®°å½•
SELECT * FROM api_sync_logs 
ORDER BY created_at DESC 
LIMIT 20;

-- æŸ¥çœ‹å¤±è´¥çš„åŒæ­¥
SELECT * FROM api_sync_logs 
WHERE status = 'failed' 
ORDER BY created_at DESC;

-- æŸ¥çœ‹åŒæ­¥ç»Ÿè®¡
SELECT sync_type, status, COUNT(*) as count, AVG(execution_time_ms) as avg_time
FROM api_sync_logs
WHERE created_at > DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY sync_type, status;
```

### æŸ¥çœ‹æ•°æ®ç»Ÿè®¡

```sql
-- æŸ¥çœ‹è”èµ›æ•°é‡
SELECT COUNT(*) FROM leagues;

-- æŸ¥çœ‹çƒé˜Ÿæ•°é‡
SELECT COUNT(*) FROM teams;

-- æŸ¥çœ‹æ¯”èµ›æ•°é‡
SELECT COUNT(*) FROM fixtures;

-- æŸ¥çœ‹æœ€è¿‘çš„æ¯”èµ›
SELECT * FROM fixtures 
ORDER BY fixture_date DESC 
LIMIT 10;
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å®šæ—¶ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
1. ç¡®ä¿ `FOOTBALL_API_KEY` å·²è®¾ç½®
2. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ä¸­çš„ "Starting polling tasks..." æ¶ˆæ¯
3. æ£€æŸ¥ `api_sync_logs` è¡¨ä¸­æ˜¯å¦æœ‰è®°å½•

### Q2: API è°ƒç”¨å¤±è´¥ï¼Ÿ

**å¯èƒ½åŸå› **:
1. API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ
2. API é…é¢å·²ç”¨å°½
3. ç½‘ç»œè¿æ¥é—®é¢˜
4. API æœåŠ¡å™¨å®•æœº

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ API Key
2. å‡çº§åˆ°ä»˜è´¹è®¡åˆ’
3. æ£€æŸ¥ç½‘ç»œè¿æ¥
4. æŸ¥çœ‹ API çŠ¶æ€é¡µé¢

### Q3: æ•°æ®åº“å†™å…¥å¤±è´¥ï¼Ÿ

**å¯èƒ½åŸå› **:
1. æ•°æ®åº“è¿æ¥æ–­å¼€
2. è¡¨ç»“æ„ä¸åŒ¹é…
3. ç£ç›˜ç©ºé—´ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. è¿è¡Œ `create_football_tables.sql` è„šæœ¬
3. æ£€æŸ¥ç£ç›˜ç©ºé—´

---

## ğŸ“ ä¸‹ä¸€æ­¥

1. **å®ç°æ•°æ®åŒæ­¥å‡½æ•°**
   - å®Œæˆ `syncLeagues()`, `syncTeams()`, `syncFixtures()` ç­‰å‡½æ•°
   - æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

2. **åˆ›å»º API ç«¯ç‚¹**
   - åˆ›å»º `/api/fixtures` ç«¯ç‚¹è¿”å›æ•°æ®åº“ä¸­çš„æ¯”èµ›
   - åˆ›å»º `/api/standings` ç«¯ç‚¹è¿”å›ç§¯åˆ†æ¦œ
   - åˆ›å»º `/api/top-scorers` ç«¯ç‚¹è¿”å›å°„æ‰‹æ¦œ

3. **å‰ç«¯é›†æˆ**
   - ä¿®æ”¹ `bongdaha2/api/fixtures.js` è°ƒç”¨ Go åç«¯ API
   - ä¿®æ”¹ `bongdaha2/public/main.js` ä½¿ç”¨æ•°æ®åº“æ•°æ®

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ·»åŠ  Redis ç¼“å­˜
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
   - æ·»åŠ  CDN åŠ é€Ÿ

